<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flekspy.tp.test_particles &mdash; flekspy  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            flekspy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../idl_data.html">FLEKS Python Visualization Toolkit: IDL Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amrex_data.html">FLEKS Python Visualization Toolkit: AMReX Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../test_particle_data.html">FLEKS Python Visualization Toolkit: Test Particle Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../algorithm.html">Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">flekspy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../flekspy.html">flekspy</a></li>
      <li class="breadcrumb-item active">flekspy.tp.test_particles</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flekspy.tp.test_particles</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flekspy.util.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineCollection</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">islice</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntEnum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">proton_mass</span><span class="p">,</span> <span class="n">elementary_charge</span><span class="p">,</span> <span class="n">mu_0</span><span class="p">,</span> <span class="n">epsilon_0</span>

<span class="n">EARTH_RADIUS_KM</span> <span class="o">=</span> <span class="mi">6378</span>


<div class="viewcode-block" id="Indices">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.Indices">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Indices</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Defines constant indices for test particles.&quot;&quot;&quot;</span>

    <span class="n">TIME</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">X</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">VX</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">VY</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">VZ</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">BX</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">BY</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">BZ</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">EX</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">EY</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">EZ</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">DBXDX</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">DBXDY</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">DBXDZ</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">DBYDX</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">DBYDY</span> <span class="o">=</span> <span class="mi">17</span>
    <span class="n">DBYDZ</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="n">DBZDX</span> <span class="o">=</span> <span class="mi">19</span>
    <span class="n">DBZDY</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">DBZDZ</span> <span class="o">=</span> <span class="mi">21</span></div>



<div class="viewcode-block" id="FLEKSTP">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FLEKSTP</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that is used to read and plot test particles. Each particle ID consists of</span>
<span class="sd">    a CPU index, a particle index on each CPU, and a location index.</span>
<span class="sd">    By default, 7 real numbers saved for each step: time + position + velocity.</span>
<span class="sd">    Additional field information are also stored if available.</span>

<span class="sd">    This class is a lazy, iterable container. It avoids loading all data into memory</span>
<span class="sd">    at once, making it efficient for large datasets. You can access particle</span>
<span class="sd">    trajectories using standard container operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        dirs (str): the path to the test particle dataset.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; tp = FLEKSTP(&quot;res/run1/PC/test_particles&quot;, iSpecies=1)</span>
<span class="sd">    &gt;&gt;&gt; len(tp)</span>
<span class="sd">    10240</span>
<span class="sd">    &gt;&gt;&gt; trajectory = tp[0]</span>
<span class="sd">    &gt;&gt;&gt; tp.plot_trajectory(tp.IDs[3])</span>
<span class="sd">    &gt;&gt;&gt; tp.save_trajectory(tp.IDs[5], format=&quot;csv&quot;)</span>
<span class="sd">    &gt;&gt;&gt; tp.save_trajectory(tp.IDs[5], format=&quot;parquet&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ids, pData = tp.read_particles_at_time(0.0, doSave=False)</span>
<span class="sd">    &gt;&gt;&gt; f = tp.plot_location(pData)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dirs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">iDomain</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">iSpecies</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;planetary&quot;</span><span class="p">,</span>
        <span class="n">mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">proton_mass</span><span class="p">,</span>
        <span class="n">charge</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">elementary_charge</span><span class="p">,</span>
        <span class="n">iListStart</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">iListEnd</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="n">use_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;planetary&quot;</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown unit: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;planetary&#39; or &#39;SI&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirs</span> <span class="o">+</span> <span class="s2">&quot;/Header&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Header file not found in </span><span class="si">{</span><span class="n">dirs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iSpecies</span> <span class="o">=</span> <span class="n">iSpecies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirs</span><span class="si">}</span><span class="s2">/FLEKS</span><span class="si">{</span><span class="n">iDomain</span><span class="si">}</span><span class="s2">_particle_species_</span><span class="si">{</span><span class="n">iSpecies</span><span class="si">}</span><span class="s2">_n*&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">iListEnd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">iListEnd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="p">[</span><span class="n">iListStart</span><span class="p">:</span><span class="n">iListEnd</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p_filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="p">:</span>
            <span class="n">plist_filename</span> <span class="o">=</span> <span class="n">p_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;_particle_species_&quot;</span><span class="p">,</span> <span class="s2">&quot;_particle_list_species_&quot;</span>
            <span class="p">)</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_particle_list</span><span class="p">(</span><span class="n">plist_filename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pID</span><span class="p">,</span> <span class="n">ploc</span> <span class="ow">in</span> <span class="n">plist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">pID</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_filename</span><span class="p">,</span> <span class="n">ploc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">IDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filetime</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_the_first_record</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">Indices</span><span class="o">.</span><span class="n">TIME</span><span class="p">])</span>

<div class="viewcode-block" id="FLEKSTP.__repr__">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Particles species ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iSpecies</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Particle mass [kg]  : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Particle charge [C] : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Unit system         : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Number of particles : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IDs</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;First time tag      : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Last  time tag      : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.__len__">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.__len__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IDs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.__iter__">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.__iter__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IDs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.__getitem__">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># Treat as an index</span>
            <span class="n">pID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># Treat as a pID</span>
            <span class="n">pID</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Particle ID must be a tuple (cpu, id) or an integer index.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If caching is not used, read directly and return.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_particle_trajectory</span><span class="p">(</span><span class="n">pID</span><span class="p">)</span>

        <span class="c1"># Caching is enabled, use the cache.</span>
        <span class="k">if</span> <span class="n">pID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_cache</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trajectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_particle_trajectory</span><span class="p">(</span><span class="n">pID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_cache</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span> <span class="o">=</span> <span class="n">trajectory</span>
            <span class="k">return</span> <span class="n">trajectory</span></div>


<div class="viewcode-block" id="FLEKSTP.getIDs">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.getIDs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDs</span></div>


<div class="viewcode-block" id="FLEKSTP.read_particle_list">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.read_particle_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_particle_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return a list of the particle IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">record_format</span> <span class="o">=</span> <span class="s2">&quot;iiQ&quot;</span>  <span class="c1"># 2 integers + 1 unsigned long long</span>
        <span class="n">record_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">record_format</span><span class="p">)</span>
        <span class="n">record_struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="n">record_format</span><span class="p">)</span>
        <span class="n">nByte</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
        <span class="n">nPart</span> <span class="o">=</span> <span class="n">nByte</span> <span class="o">//</span> <span class="n">record_size</span>
        <span class="n">plist</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPart</span><span class="p">):</span>
                <span class="n">dataChunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">record_size</span><span class="p">)</span>
                <span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="o">=</span> <span class="n">record_struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">dataChunk</span><span class="p">)</span>
                <span class="n">plist</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">cpu</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span> <span class="n">loc</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">plist</span></div>


<div class="viewcode-block" id="FLEKSTP._read_the_first_record">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._read_the_first_record">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_the_first_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the first record stored in one file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">binaryData</span><span class="p">:</span>
                    <span class="k">break</span>  <span class="c1"># EOF</span>

                <span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">idtmp</span><span class="p">,</span> <span class="n">nRecord</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;iiif&quot;</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nRecord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">)</span>
                    <span class="n">dataList</span> <span class="o">=</span> <span class="n">dataList</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;f&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">dataList</span></div>


<div class="viewcode-block" id="FLEKSTP.read_particles_at_time">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.read_particles_at_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_particles_at_time</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">doSave</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the information of all the particles at a given time.</span>
<span class="sd">        If doSave, save to a CSV file with the name &quot;particles_t***.csv&quot;.</span>

<span class="sd">        Note that the time tags in filetime do not include the last saved time.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ids: a numpy array of tuples contains the particle IDs.</span>
<span class="sd">            pData: a numpy real array with the particle weight, location and velocity.</span>

<span class="sd">        Examples:</span>
<span class="sd">        &gt;&gt;&gt; ids, pData = pt.read_particles_at_time(3700, doSave=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nFile</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are no particles at time </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">iFile</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">iFile</span> <span class="o">&lt;</span> <span class="n">nFile</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetime</span><span class="p">[</span><span class="n">iFile</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="n">iFile</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfiles</span><span class="p">[</span><span class="n">iFile</span><span class="p">]</span>

        <span class="n">dataList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">binaryData</span><span class="p">:</span>
                    <span class="k">break</span>  <span class="c1"># EOF</span>

                <span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">idtmp</span><span class="p">,</span> <span class="n">nRecord</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;iiif&quot;</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">)</span>
                <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">*</span> <span class="n">nRecord</span><span class="p">)</span>
                <span class="n">allRecords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;f&quot;</span> <span class="o">*</span> <span class="n">nRecord</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nRecord</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">allRecords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">Indices</span><span class="o">.</span><span class="n">TIME</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">time</span><span class="p">:</span>
                        <span class="n">dataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">allRecords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">*</span> <span class="n">i</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                        <span class="p">)</span>
                        <span class="n">idList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cpu</span><span class="p">,</span> <span class="n">idtmp</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">i</span> <span class="o">==</span> <span class="n">nRecord</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">allRecords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">Indices</span><span class="o">.</span><span class="n">TIME</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">time</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

        <span class="n">npData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataList</span><span class="p">)</span>
        <span class="n">idData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idList</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i,i&quot;</span><span class="p">)</span>
        <span class="c1"># Selected time is larger than the last saved time</span>
        <span class="k">if</span> <span class="n">idData</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are no particles at time </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doSave</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;particles_t</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;cpu,iid,time,x,y,z,vx,vy,vz&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot;,bx,by,bz&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot;,bx,by,bz,ex,ey,ez&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s2">&quot;,dbxdx,dbxdy,dbxdz,dbydx,dbydy,dbydz,dbzdx,dbzdy,dbzdz&quot;</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">id_row</span><span class="p">,</span> <span class="n">data_row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idData</span><span class="p">,</span> <span class="n">npData</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">id_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">id_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data_row</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">idData</span><span class="p">,</span> <span class="n">npData</span></div>


<div class="viewcode-block" id="FLEKSTP.save_trajectory">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.save_trajectory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_trajectory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shiftTime</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">scaleTime</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the trajectory of a particle to a file.</span>
<span class="sd">        Args:</span>
<span class="sd">            pID: particle ID.</span>
<span class="sd">            filename (str, optional): The name of the file to save the trajectory to.</span>
<span class="sd">                                      If None, a default name will be generated.</span>
<span class="sd">            shiftTime (bool): If set to True, set the initial time to be 0.</span>
<span class="sd">            scaleTime (bool): If set to True, scale the time into [0,1] range.</span>
<span class="sd">            format (str): The output format, either &quot;csv&quot; or &quot;parquet&quot;.</span>
<span class="sd">        Example:</span>
<span class="sd">        &gt;&gt;&gt; tp.save_trajectory((3,15), format=&quot;parquet&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pData_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;trajectory_</span><span class="si">{</span><span class="n">pID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">pID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">header_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;time [s]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;X [R]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Y [R]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Z [R]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;U_x [km/s]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;U_y [km/s]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;U_z [km/s]&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">header_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;B_x [nT]&quot;</span><span class="p">,</span> <span class="s2">&quot;B_y [nT]&quot;</span><span class="p">,</span> <span class="s2">&quot;B_z [nT]&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
                <span class="n">header_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;E_x [uV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;E_y [uV/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;E_z [uV/m]&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">header_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;time [s]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;X [m]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Y [m]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Z [m]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;U_x [m/s]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;U_y [m/s]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;U_z [m/s]&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">header_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;B_x [T]&quot;</span><span class="p">,</span> <span class="s2">&quot;B_y [T]&quot;</span><span class="p">,</span> <span class="s2">&quot;B_z [T]&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
                <span class="n">header_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;E_x [V/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;E_y [V/m]&quot;</span><span class="p">,</span> <span class="s2">&quot;E_z [V/m]&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;=</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">header_cols</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;dBx_dx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBx_dy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBx_dz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBy_dx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBy_dy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBy_dz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBz_dx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBz_dy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dBz_dz&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">shiftTime</span><span class="p">:</span>
            <span class="n">first_time</span> <span class="o">=</span> <span class="n">pData_lazy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">first_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pData_lazy</span> <span class="o">=</span> <span class="n">pData_lazy</span><span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">first_time</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">scaleTime</span><span class="p">:</span>
                    <span class="n">last_time</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">pData_lazy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pData_lazy</span> <span class="o">=</span> <span class="n">pData_lazy</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">last_time</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c1"># Create a new LazyFrame with the desired header names</span>
        <span class="n">pData_to_save</span> <span class="o">=</span> <span class="n">pData_lazy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">original_name</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">original_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pData_lazy</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">header_cols</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">pData_to_save</span><span class="o">.</span><span class="n">sink_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
                <span class="n">pData_to_save</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported format: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">PolarsError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving trajectory to </span><span class="si">{</span><span class="nb">format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.save_trajectories">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.save_trajectories">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_trajectories</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pIDs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;trajectories.h5&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the trajectories of multiple particles to a single HDF5 file.</span>

<span class="sd">        Args:</span>
<span class="sd">            pIDs: A list of particle IDs to save. This can be a list of tuples</span>
<span class="sd">                  (cpu, id) or a list of integer indices.</span>
<span class="sd">            filename (str): The name of the HDF5 file to save the trajectories to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pIDs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># Handle list of integer indices</span>
                <span class="k">for</span> <span class="n">pID</span> <span class="ow">in</span> <span class="n">pIDs</span><span class="p">:</span>
                    <span class="n">pData_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
                    <span class="n">pData</span> <span class="o">=</span> <span class="n">pData_lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="n">dataset_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ID_</span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pData</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
                    <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pData</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle list of tuples</span>
                <span class="k">for</span> <span class="n">pID</span> <span class="ow">in</span> <span class="n">pIDs</span><span class="p">:</span>
                    <span class="n">pData_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
                    <span class="n">pData</span> <span class="o">=</span> <span class="n">pData_lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="n">dataset_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ID_</span><span class="si">{</span><span class="n">pID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">pID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pData</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
                    <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pData</span><span class="o">.</span><span class="n">columns</span></div>


<div class="viewcode-block" id="FLEKSTP._get_particle_raw_data">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._get_particle_raw_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_particle_raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads all raw trajectory data for a particle across multiple files.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">data_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">record_format</span> <span class="o">=</span> <span class="s2">&quot;iiif&quot;</span>
        <span class="n">record_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">record_format</span><span class="p">)</span>
        <span class="n">record_struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="n">record_format</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ploc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="p">[</span><span class="n">pID</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ploc</span><span class="p">)</span>
                <span class="n">dataChunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">record_size</span><span class="p">)</span>
                <span class="p">(</span><span class="n">_cpu</span><span class="p">,</span> <span class="n">_idtmp</span><span class="p">,</span> <span class="n">nRecord</span><span class="p">,</span> <span class="n">_weight</span><span class="p">)</span> <span class="o">=</span> <span class="n">record_struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">dataChunk</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nRecord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">*</span> <span class="n">nRecord</span><span class="p">)</span>
                    <span class="n">data_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">binaryData</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_chunks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data_chunks</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP._read_particle_record">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._read_particle_record">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_particle_record</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a specific record of a test particle given its ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID: particle ID</span>
<span class="sd">            index: The index of the record to be returned.</span>
<span class="sd">                   0: first record.</span>
<span class="sd">                   -1: last record (default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locations</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">record_format</span> <span class="o">=</span> <span class="s2">&quot;iiif&quot;</span>
        <span class="n">record_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">record_format</span><span class="p">)</span>
        <span class="n">record_struct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="n">record_format</span><span class="p">)</span>

        <span class="c1"># Optimized path for the first record (index=0)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ploc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ploc</span><span class="p">)</span>
                    <span class="n">dataChunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">record_size</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">_cpu</span><span class="p">,</span> <span class="n">_idtmp</span><span class="p">,</span> <span class="n">nRecord</span><span class="p">,</span> <span class="n">_weight</span><span class="p">)</span> <span class="o">=</span> <span class="n">record_struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">dataChunk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nRecord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Found the first chunk with records, read the first one and return</span>
                        <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;f&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">))</span>

        <span class="c1"># Optimized path for the last record (index=-1)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ploc</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">locations</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ploc</span><span class="p">)</span>
                    <span class="n">dataChunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">record_size</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">_cpu</span><span class="p">,</span> <span class="n">_idtmp</span><span class="p">,</span> <span class="n">nRecord</span><span class="p">,</span> <span class="n">_weight</span><span class="p">)</span> <span class="o">=</span> <span class="n">record_struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">dataChunk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nRecord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># This is the last chunk of data for this particle.</span>
                        <span class="c1"># Seek to the last record within this chunk.</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">ploc</span> <span class="o">+</span> <span class="n">record_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">nRecord</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="n">binaryData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;f&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Only index 0 and -1 are supported</span></div>


<div class="viewcode-block" id="FLEKSTP.read_particle_trajectory">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.read_particle_trajectory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_particle_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the trajectory of a test particle as a polars LazyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_locations</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Particle ID </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

        <span class="n">data_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_particle_raw_data</span><span class="p">(</span><span class="n">pID</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No trajectory data found for particle ID </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">nRecord</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span>
        <span class="n">trajectory_data</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nRecord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">)</span>

        <span class="c1"># Use the Indices enum to create meaningful column names</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">islice</span><span class="p">(</span><span class="n">Indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span><span class="p">)]</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">trajectory_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lf</span></div>


<div class="viewcode-block" id="FLEKSTP.read_initial_condition">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.read_initial_condition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_initial_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the initial conditions of a test particle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_particle_record</span><span class="p">(</span><span class="n">pID</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.read_final_condition">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.read_final_condition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_final_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the final conditions of a test particle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_particle_record</span><span class="p">(</span><span class="n">pID</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.select_particles">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.select_particles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_select</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the test particles whose initial conditions satisfy the requirement</span>
<span class="sd">        set by the user defined function f_select. The first argument of f_select is the</span>
<span class="sd">        particle ID, and the second argument is the ID of a particle.</span>

<span class="sd">        Examples:</span>
<span class="sd">        &gt;&gt;&gt; from flekspy.tp import Indices</span>
<span class="sd">        &gt;&gt;&gt; def f_select(tp, pid):</span>
<span class="sd">        &gt;&gt;&gt;     pData = tp.read_initial_condition(pid)</span>
<span class="sd">        &gt;&gt;&gt;     inTime = pData[Indices.TIME] &lt; 3601</span>
<span class="sd">        &gt;&gt;&gt;     inRegion = pData[Indices.X] &gt; 20</span>
<span class="sd">        &gt;&gt;&gt;     return inTime and inRegion</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; pselected = tp.select_particles(f_select)</span>
<span class="sd">        &gt;&gt;&gt; tp.plot_trajectory(list(pselected.keys())[1])</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">f_select</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">f_select</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">pSelected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pid</span><span class="p">:</span> <span class="n">f_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pSelected</span></div>


<div class="viewcode-block" id="FLEKSTP.get_kinetic_energy">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_kinetic_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_kinetic_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="p">(</span><span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="n">elementary_charge</span>
            <span class="p">)</span>  <span class="c1"># [eV]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="p">(</span><span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">elementary_charge</span>  <span class="c1"># [eV]</span>

        <span class="k">return</span> <span class="n">ke</span></div>


<div class="viewcode-block" id="FLEKSTP.get_kinetic_energy_change_rate">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_kinetic_energy_change_rate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_kinetic_energy_change_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the rate of change of kinetic energy in [eV/s].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select only necessary columns before collecting to improve performance.</span>
        <span class="n">collected</span> <span class="o">=</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">ke</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
        <span class="n">dke_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;dke_dt&quot;</span><span class="p">,</span> <span class="n">dke_dt</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP.get_pitch_angle">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_pitch_angle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pitch_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">):</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="c1"># Pitch Angle Calculation</span>
        <span class="n">pitch_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pitch_angle_lazy</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pitch_angle</span></div>


<div class="viewcode-block" id="FLEKSTP._get_pitch_angle_lazy">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._get_pitch_angle_lazy">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pitch_angle_lazy</span><span class="p">(</span><span class="n">lf</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the pitch angle from a LazyFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pitch Angle Calculation</span>
        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">v_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>
        <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_mag</span> <span class="o">*</span> <span class="n">b_mag</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
        <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">cos_alpha</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">pitch_angle_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos_alpha</span><span class="o">.</span><span class="n">arccos</span><span class="p">()</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pitch_angle&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pitch_angle_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.get_pitch_angle_from_v_b">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_pitch_angle_from_v_b">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pitch_angle_from_v_b</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
        <span class="c1"># Pitch Angle Calculation</span>
        <span class="n">v_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">b_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Calculate magnitudes of velocity and B-field vectors</span>
        <span class="n">v_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate the dot product between V and B for each time step</span>
        <span class="c1"># Equivalent to (vx*bx + vy*by + vz*bz)</span>
        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_vec</span> <span class="o">*</span> <span class="n">b_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># To avoid division by zero if either vector magnitude is zero</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>

        <span class="c1"># Calculate the cosine of the pitch angle</span>
        <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_mag</span> <span class="o">*</span> <span class="n">b_mag</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="c1"># Due to potential floating point inaccuracies, clip values to the valid range for arccos</span>
        <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_alpha</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Calculate pitch angle and convert from radians to degrees</span>
        <span class="n">pitch_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_alpha</span><span class="p">)</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">return</span> <span class="n">pitch_angle</span></div>


<div class="viewcode-block" id="FLEKSTP.get_first_adiabatic_invariant">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_first_adiabatic_invariant">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_first_adiabatic_invariant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the 1st adiabatic invariant of a particle.</span>
<span class="sd">        The output units depend on the input data&#39;s units:</span>
<span class="sd">        - &quot;planetary&quot; (e.g., velocity in km/s, B-field in nT): result is in [1e9 J/T].</span>
<span class="sd">        - &quot;SI&quot; (e.g., velocity in m/s, B-field in T): result is in [J/T].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>

        <span class="c1"># Build the expression tree for the calculation</span>
        <span class="n">v_mag_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">v_mag</span> <span class="o">=</span> <span class="n">v_mag_sq</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">b_mag_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">sin_alpha_sq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">v_dot_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_mag</span> <span class="o">*</span> <span class="n">b_mag_expr</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">v_perp_sq</span> <span class="o">=</span> <span class="n">v_mag_sq</span> <span class="o">*</span> <span class="n">sin_alpha_sq</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># Convert v_perp_sq from (km/s)^2 to (m/s)^2</span>
            <span class="n">v_perp_sq</span> <span class="o">=</span> <span class="n">v_perp_sq</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="n">mu_expr</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp_sq</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b_mag_expr</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">)</span>

        <span class="c1"># Execute the expression and return</span>
        <span class="k">return</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">mu_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="s2">&quot;mu&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FLEKSTP._calculate_bmag">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._calculate_bmag">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_bmag</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the magnetic field magnitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">b_mag</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FLEKSTP._calculate_curvature">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._calculate_curvature">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_curvature</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the magnetic field curvature vector and adds it to the DataFrame.</span>
<span class="sd">        κ = (b ⋅ ∇)b</span>
<span class="sd">        Depending on the selected units, output curvature may be</span>
<span class="sd">        - &quot;planetary&quot;: [1/RE]</span>
<span class="sd">        - &quot;SI&quot;: [1/m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">FLEKSTP</span><span class="o">.</span><span class="n">_calculate_bmag</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Chain with_columns for better readability and performance</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">bx_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">by_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">bz_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dbx_u_dx</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbxdx&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dbx_u_dy</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbxdy&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dbx_u_dz</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbxdz&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dby_u_dx</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbydx&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dby_u_dy</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbydy&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dby_u_dz</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbydz&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dbz_u_dx</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbzdx&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dbz_u_dy</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbzdy&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="n">dbz_u_dz</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbzdz&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Curvature vector: κ = (b ⋅ ∇)b</span>
        <span class="n">kappa_x</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbx_u_dx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbx_u_dy&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbx_u_dz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">kappa_y</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dby_u_dx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dby_u_dy&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dby_u_dz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">kappa_z</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbz_u_dx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbz_u_dy&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbz_u_dz&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">kappa_x</span><span class="o">=</span><span class="n">kappa_x</span><span class="p">,</span> <span class="n">kappa_y</span><span class="o">=</span><span class="n">kappa_y</span><span class="p">,</span> <span class="n">kappa_z</span><span class="o">=</span><span class="n">kappa_z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FLEKSTP.get_ExB_drift">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_ExB_drift">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ExB_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the convection drift velocity for a particle.</span>
<span class="sd">        v_exb = E x B / (B^2)</span>
<span class="sd">        Assuming Earth&#39;s planetary units, output drift velocity in [km/s].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_bmag</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>

        <span class="c1"># E x B expressions</span>
        <span class="n">cross_x</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span>
        <span class="n">cross_y</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span>
        <span class="n">cross_z</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>

        <span class="n">b_mag_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">vex</span><span class="o">=</span><span class="n">cross_x</span> <span class="o">/</span> <span class="n">b_mag_sq</span><span class="p">,</span>
            <span class="n">vey</span><span class="o">=</span><span class="n">cross_y</span> <span class="o">/</span> <span class="n">b_mag_sq</span><span class="p">,</span>
            <span class="n">vez</span><span class="o">=</span><span class="n">cross_z</span> <span class="o">/</span> <span class="n">b_mag_sq</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">lf</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;vex&quot;</span><span class="p">,</span> <span class="s2">&quot;vey&quot;</span><span class="p">,</span> <span class="s2">&quot;vez&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.get_curvature_drift">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_curvature_drift">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_curvature_drift</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the curvature drift velocity for a particle.</span>
<span class="sd">        v_c = (m * v_parallel^2 / (q*B^2)) * (B x κ)</span>
<span class="sd">        Depending on the selected units, output drift velocity may be</span>
<span class="sd">        - &quot;planetary&quot;: [km/s]</span>
<span class="sd">        - &quot;SI&quot;: [m/s]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_bmag</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>

        <span class="c1"># Calculate v_parallel using expressions</span>
        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">v_parallel</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">v_parallel</span><span class="o">=</span><span class="n">v_parallel</span><span class="p">)</span>

        <span class="c1"># Calculate curvature</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_curvature</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>

        <span class="c1"># B x κ using expressions</span>
        <span class="n">cross_x</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_z&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_y&quot;</span><span class="p">)</span>
        <span class="n">cross_y</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_x&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_z&quot;</span><span class="p">)</span>
        <span class="n">cross_z</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_y&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_x&quot;</span><span class="p">)</span>

        <span class="c1"># Conversion factor expression</span>
        <span class="n">v_parallel_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;v_parallel&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">b_mag_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_parallel_sq</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">b_mag_sq</span><span class="p">)</span>
                <span class="o">*</span> <span class="mf">1e9</span>
                <span class="o">/</span> <span class="n">EARTH_RADIUS_KM</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_parallel_sq</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">b_mag_sq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown unit: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;planetary&#39; or &#39;SI&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="n">lf</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">vcx</span><span class="o">=</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cross_x</span><span class="p">,</span> <span class="n">vcy</span><span class="o">=</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cross_y</span><span class="p">,</span> <span class="n">vcz</span><span class="o">=</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cross_z</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">lf</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;vcx&quot;</span><span class="p">,</span> <span class="s2">&quot;vcy&quot;</span><span class="p">,</span> <span class="s2">&quot;vcz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.get_adiabaticity_parameter">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_adiabaticity_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_adiabaticity_parameter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the adiabaticity parameter, defined as the ratio of the</span>
<span class="sd">        magnetic field&#39;s radius of curvature to the particle&#39;s gyroradius.</span>
<span class="sd">        When this parameter is &gt;&gt; 1, the motion is adiabatic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Expression for v_perp</span>
        <span class="n">v_mag_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sin_alpha_sq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">v_dot_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_mag_sq</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">v_perp</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_mag_sq</span> <span class="o">*</span> <span class="n">sin_alpha_sq</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="c1"># Expression for curvature radius</span>
        <span class="n">lf_curv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_curvature</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>
        <span class="n">kappa_mag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_x&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_y&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kappa_z&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># v_perp [km/s], b_mag [nT] -&gt; r_g [km]</span>
            <span class="n">r_g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="c1"># kappa_mag [1/RE] -&gt; r_c [km]</span>
            <span class="n">r_c_factor</span> <span class="o">=</span> <span class="n">EARTH_RADIUS_KM</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="c1"># v_perp [m/s], b_mag [T] -&gt; r_g [m]</span>
            <span class="n">r_g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">)</span>
            <span class="c1"># kappa_mag [1/m] -&gt; r_c [m]</span>
            <span class="n">r_c_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown unit: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;planetary&#39; or &#39;SI&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="n">r_c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">kappa_mag</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_c_factor</span>

        <span class="n">ratio_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_c</span> <span class="o">/</span> <span class="n">r_g</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;adiabaticity&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lf_curv</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ratio_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP._calculate_gradient_b_magnitude">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._calculate_gradient_b_magnitude">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_gradient_b_magnitude</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the gradient of the magnetic field magnitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Gradient of B magnitude: ∇|B|</span>
        <span class="n">grad_b_mag_x</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbxdx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbydx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbzdx&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span>
        <span class="n">grad_b_mag_y</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbxdy&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbydy&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbzdy&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span>
        <span class="n">grad_b_mag_z</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbxdz&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbydz&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dbzdz&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">grad_b_mag_x</span><span class="o">=</span><span class="n">grad_b_mag_x</span><span class="p">,</span>
            <span class="n">grad_b_mag_y</span><span class="o">=</span><span class="n">grad_b_mag_y</span><span class="p">,</span>
            <span class="n">grad_b_mag_z</span><span class="o">=</span><span class="n">grad_b_mag_z</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FLEKSTP.get_gradient_drift">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_gradient_drift">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_gradient_drift</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the gradient drift velocity for a particle.</span>
<span class="sd">        v_g = (μ / (q * B^2)) * (B x ∇|B|)</span>
<span class="sd">        Depending on the selected units, output drift velocity may be</span>
<span class="sd">        - &quot;planetary&quot;: [km/s]</span>
<span class="sd">        - &quot;SI&quot;: [m/s]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>

        <span class="c1"># Inlined expression for mu</span>
        <span class="n">v_mag_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">v_mag</span> <span class="o">=</span> <span class="n">v_mag_sq</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sin_alpha_sq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">v_dot_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_mag</span> <span class="o">*</span> <span class="n">b_mag</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">v_perp_sq</span> <span class="o">=</span> <span class="n">v_mag_sq</span> <span class="o">*</span> <span class="n">sin_alpha_sq</span>
        <span class="n">mu_expr</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp_sq</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b_mag</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="n">lf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_bmag</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>

        <span class="c1"># Gradient of B magnitude: ∇|B|</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_gradient_b_magnitude</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>

        <span class="c1"># B x ∇|B|</span>
        <span class="n">cross_x</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_z&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
            <span class="s2">&quot;grad_b_mag_y&quot;</span>
        <span class="p">)</span>
        <span class="n">cross_y</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_x&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
            <span class="s2">&quot;grad_b_mag_z&quot;</span>
        <span class="p">)</span>
        <span class="n">cross_z</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_y&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
            <span class="s2">&quot;grad_b_mag_x&quot;</span>
        <span class="p">)</span>

        <span class="n">b_mag_sq</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="c1"># conversion factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">mu_expr</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">b_mag_sq</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">EARTH_RADIUS_KM</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">mu_expr</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">b_mag_sq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown unit: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;planetary&#39; or &#39;SI&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="n">lf</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">vgx</span><span class="o">=</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cross_x</span><span class="p">,</span> <span class="n">vgy</span><span class="o">=</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cross_y</span><span class="p">,</span> <span class="n">vgz</span><span class="o">=</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cross_z</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">lf</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;vgx&quot;</span><span class="p">,</span> <span class="s2">&quot;vgy&quot;</span><span class="p">,</span> <span class="s2">&quot;vgz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.get_polarization_drift">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_polarization_drift">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_polarization_drift</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt_lazy</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the polarization drift velocity for a particle.</span>
<span class="sd">        v_p = (m / (q * B^2)) * (dE_perp / dt)</span>
<span class="sd">        Depending on the selected units, output drift velocity may be</span>
<span class="sd">        - &quot;planetary&quot;: [km/s]</span>
<span class="sd">        - &quot;SI&quot;: [m/s]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Calculate B magnitude and unit vector</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">bx_u</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag</span>
        <span class="n">by_u</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag</span>
        <span class="n">bz_u</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag</span>

        <span class="c1"># Calculate E_parallel = (E.b)b</span>
        <span class="n">E_dot_b</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bx_u</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">by_u</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bz_u</span>
        <span class="n">E_parallel_x</span> <span class="o">=</span> <span class="n">E_dot_b</span> <span class="o">*</span> <span class="n">bx_u</span>
        <span class="n">E_parallel_y</span> <span class="o">=</span> <span class="n">E_dot_b</span> <span class="o">*</span> <span class="n">by_u</span>
        <span class="n">E_parallel_z</span> <span class="o">=</span> <span class="n">E_dot_b</span> <span class="o">*</span> <span class="n">bz_u</span>

        <span class="c1"># Calculate E_perp = E - E_parallel</span>
        <span class="n">E_perp_x</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">E_parallel_x</span>
        <span class="n">E_perp_y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">E_parallel_y</span>
        <span class="n">E_perp_z</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">E_parallel_z</span>

        <span class="c1"># Calculate dE_perp/dt</span>
        <span class="n">dE_perp_dt_x</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">E_perp_x</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
        <span class="n">dE_perp_dt_y</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">E_perp_y</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
        <span class="n">dE_perp_dt_z</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">E_perp_z</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

        <span class="n">b_mag_sq</span> <span class="o">=</span> <span class="n">b_mag</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># E is in [uV/m], B is in [nT]</span>
            <span class="c1"># Convert to SI: E[V/m] = E[uV/m]*1e-6, B[T] = B[nT]*1e-9</span>
            <span class="c1"># v_p [m/s] = (m[kg] / (q[C] * (B[nT]*1e-9)^2)) * (dE_perp/dt[uV/m/s] * 1e-6)</span>
            <span class="c1"># v_p [m/s] = (m/(q*B^2)) * (dE_perp/dt) * 1e12</span>
            <span class="c1"># To get km/s, we divide by 1e3</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">b_mag_sq</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">b_mag_sq</span><span class="p">)</span>

        <span class="n">vpx</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dE_perp_dt_x</span>
        <span class="n">vpy</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dE_perp_dt_y</span>
        <span class="n">vpz</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dE_perp_dt_z</span>

        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;vpx&quot;</span><span class="p">:</span> <span class="n">vpx</span><span class="p">,</span> <span class="s2">&quot;vpy&quot;</span><span class="p">:</span> <span class="n">vpy</span><span class="p">,</span> <span class="s2">&quot;vpz&quot;</span><span class="p">:</span> <span class="n">vpz</span><span class="p">})</span></div>


<div class="viewcode-block" id="FLEKSTP.get_betatron_acceleration">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_betatron_acceleration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_betatron_acceleration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the Betatron acceleration term from particle trajectory data.</span>

<span class="sd">        The calculation follows the formula: dW/dt = μ * (∂B/∂t)</span>
<span class="sd">        where the partial derivative is found using: ∂B/∂t = dB/dt - v ⋅ ∇B</span>

<span class="sd">        Args:</span>
<span class="sd">            pt: A Polars LazyFrame containing the particle trajectory.</span>
<span class="sd">                     It must include columns for time, velocity (vx, vy, vz),</span>
<span class="sd">                     magnetic field (bx, by, bz), and the magnetic field</span>
<span class="sd">                     gradient tensor (e.g., &#39;dbxdx&#39;, &#39;dbydx&#39;, etc.).</span>
<span class="sd">            mu: A Polars Series containing the magnetic moment (first adiabatic invariant)</span>
<span class="sd">                of the particle.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new Polars LazyFrame with added intermediate columns and the</span>
<span class="sd">            final &#39;dW_betatron&#39; column representing the rate of energy change in [eV/s].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># --- Step 1: Calculate the total derivative dB/dt ---</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">b_mag</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>

        <span class="n">collected</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">B_mag</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="s2">&quot;b_mag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">collected</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">dB_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">B_mag</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">)</span>  <span class="c1"># [nT/s]</span>

        <span class="c1"># --- Step 2: Define the rest of the calculations lazily ---</span>
        <span class="n">pt_with_dbdt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dB_dt&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">dB_dt</span><span class="p">))</span>

        <span class="c1"># Gradient of B magnitude: ∇|B|</span>
        <span class="n">pt_with_dbdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_gradient_b_magnitude</span><span class="p">(</span><span class="n">pt_with_dbdt</span><span class="p">)</span>

        <span class="c1"># Convective derivative: v ⋅ ∇|B| [nT/s]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">v_dot_gradB</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_x&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_y&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_z&quot;</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">EARTH_RADIUS_KM</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">v_dot_gradB</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_x&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_y&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;grad_b_mag_z&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># --- Step 3: Calculate the partial derivative ∂B/∂t ---</span>
        <span class="n">partial_B_partial_t</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dB_dt&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">v_dot_gradB</span>

        <span class="c1"># --- Step 4: Chain all calculations and compute the final Betatron term ---</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pt_with_dbdt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">v_dot_gradB</span><span class="o">=</span><span class="n">v_dot_gradB</span><span class="p">,</span>
            <span class="n">partial_B_partial_t</span><span class="o">=</span><span class="n">partial_B_partial_t</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Unit conversion to [eV/s].</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># mu is in [1e9 J/T], partial_B_partial_t is in [nT/s].</span>
            <span class="c1"># The product mu * partial_B_partial_t is in [J/s] because</span>
            <span class="c1"># the nT -&gt; T conversion (1e-9) and the mu unit (1e9) cancel out.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">dW_betatron</span><span class="o">=</span><span class="n">mu</span> <span class="o">*</span> <span class="n">partial_B_partial_t</span> <span class="o">/</span> <span class="n">elementary_charge</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="c1"># mu is in [J/T], partial_B_partial_t is in [T/s].</span>
            <span class="c1"># The product is directly in [J/s].</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">dW_betatron</span><span class="o">=</span><span class="n">mu</span> <span class="o">*</span> <span class="n">partial_B_partial_t</span> <span class="o">/</span> <span class="n">elementary_charge</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="FLEKSTP.get_energy_change_guiding_center">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_energy_change_guiding_center">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_energy_change_guiding_center</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the change of energy of a single particle based on the guiding center theory.</span>

<span class="sd">        The formula is given by:</span>
<span class="sd">        dW/dt = q*E_parallel*v_parallel + mu*(∂B/∂t + u_E.∇B) + m*v_parallel^2*(u_E.κ)</span>

<span class="sd">        where W is the particle energy, B is the magnetic field magnitude,</span>
<span class="sd">        u_E is the E cross B drift, and κ is the magnetic field curvature.</span>
<span class="sd">        The first term on the right hand side is the parallel acceleration,</span>
<span class="sd">        the second term is the Betatron acceleration, and the third term</span>
<span class="sd">        is one type of Fermi acceleration.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID (Tuple[int, int]): The particle ID (cpu, id).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A Polars DataFrame with the time, the three energy change components,</span>
<span class="sd">            and the total, in [eV/s].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>

        <span class="c1"># It&#39;s easier to work with collected data for this kind of calculation</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="c1"># --- Common quantities ---</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_adiabatic_invariant</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>  <span class="c1"># returns Series</span>
        <span class="n">u_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ExB_drift</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>  <span class="c1"># returns DataFrame</span>

        <span class="c1"># B magnitude and unit vectors</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="n">b_mag</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">)</span>
        <span class="n">bx_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span>
        <span class="n">by_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span>
        <span class="n">bz_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span>

        <span class="c1"># Parallel E and v</span>
        <span class="n">E_parallel</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bx_u</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">by_u</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bz_u</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="s2">&quot;E_parallel&quot;</span>
        <span class="p">)</span>
        <span class="n">v_parallel</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bx_u</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">by_u</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bz_u</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="s2">&quot;v_parallel&quot;</span>
        <span class="p">)</span>

        <span class="c1"># --- 1. Parallel Acceleration Term ---</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">unit_factor_parallel</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># (uV/m)*(km/s) -&gt; 1e-3 J/C/s</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># SI</span>
            <span class="n">unit_factor_parallel</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">dW_parallel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">elementary_charge</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">E_parallel</span>
            <span class="o">*</span> <span class="n">v_parallel</span>
            <span class="o">*</span> <span class="n">unit_factor_parallel</span>
        <span class="p">)</span>
        <span class="n">dW_parallel</span> <span class="o">=</span> <span class="n">dW_parallel</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;dW_parallel&quot;</span><span class="p">)</span>

        <span class="c1"># --- 2. Betatron Acceleration Term ---</span>
        <span class="c1"># ∂B/∂t = dB/dt - v ⋅ ∇B</span>
        <span class="n">dB_dt</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">b_mag</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;dB_dt&quot;</span><span class="p">)</span>

        <span class="c1"># Need nabla B</span>
        <span class="n">pt_with_b_mag</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">b_mag</span><span class="p">)</span>
        <span class="n">nabla_b_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_gradient_b_magnitude</span><span class="p">(</span>
            <span class="n">pt_with_b_mag</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">v_dot_gradB</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nabla_b_df</span><span class="p">[</span><span class="s2">&quot;grad_b_mag_x&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nabla_b_df</span><span class="p">[</span><span class="s2">&quot;grad_b_mag_y&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nabla_b_df</span><span class="p">[</span><span class="s2">&quot;grad_b_mag_z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">v_dot_gradB</span> <span class="o">=</span> <span class="n">v_dot_gradB</span> <span class="o">/</span> <span class="n">EARTH_RADIUS_KM</span>  <span class="c1"># nT/s</span>

        <span class="n">partial_B_partial_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">dB_dt</span> <span class="o">-</span> <span class="n">v_dot_gradB</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;partial_B_partial_t&quot;</span><span class="p">)</span>

        <span class="c1"># u_E . nabla B</span>
        <span class="n">u_E_dot_nabla_B</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">u_E</span><span class="p">[</span><span class="s2">&quot;vex&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nabla_b_df</span><span class="p">[</span><span class="s2">&quot;grad_b_mag_x&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">u_E</span><span class="p">[</span><span class="s2">&quot;vey&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nabla_b_df</span><span class="p">[</span><span class="s2">&quot;grad_b_mag_y&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">u_E</span><span class="p">[</span><span class="s2">&quot;vez&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nabla_b_df</span><span class="p">[</span><span class="s2">&quot;grad_b_mag_z&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">u_E_dot_nabla_B</span> <span class="o">=</span> <span class="n">u_E_dot_nabla_B</span> <span class="o">/</span> <span class="n">EARTH_RADIUS_KM</span>  <span class="c1"># nT/s</span>

        <span class="n">betatron_term_in_paren</span> <span class="o">=</span> <span class="n">partial_B_partial_t</span> <span class="o">+</span> <span class="n">u_E_dot_nabla_B</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># mu is in [J/nT], term is in [nT/s] -&gt; J/s</span>
            <span class="n">dW_betatron_J_s</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">betatron_term_in_paren</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># SI</span>
            <span class="c1"># mu is in [J/T], term is in [T/s] -&gt; J/s</span>
            <span class="n">dW_betatron_J_s</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">betatron_term_in_paren</span>

        <span class="n">dW_betatron</span> <span class="o">=</span> <span class="p">(</span><span class="n">dW_betatron_J_s</span> <span class="o">/</span> <span class="n">elementary_charge</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;dW_betatron&quot;</span><span class="p">)</span>

        <span class="c1"># --- 3. Fermi Acceleration Term ---</span>
        <span class="c1"># m * v_parallel^2 * (u_E . kappa)</span>
        <span class="n">kappa_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_curvature</span><span class="p">(</span><span class="n">pt_with_b_mag</span><span class="o">.</span><span class="n">lazy</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">u_E_dot_kappa</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">u_E</span><span class="p">[</span><span class="s2">&quot;vex&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kappa_df</span><span class="p">[</span><span class="s2">&quot;kappa_x&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">u_E</span><span class="p">[</span><span class="s2">&quot;vey&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kappa_df</span><span class="p">[</span><span class="s2">&quot;kappa_y&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">u_E</span><span class="p">[</span><span class="s2">&quot;vez&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kappa_df</span><span class="p">[</span><span class="s2">&quot;kappa_z&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">v_parallel_sq</span> <span class="o">=</span> <span class="n">v_parallel</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># v_parallel is km/s -&gt; m/s, so v^2 -&gt; v^2*1e6</span>
            <span class="n">v_parallel_sq_si</span> <span class="o">=</span> <span class="n">v_parallel_sq</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># (m/s)^2</span>
            <span class="c1"># u_E_dot_kappa is km/s/RE. To get 1/s, divide by RE_km</span>
            <span class="n">u_E_dot_kappa_inv_s</span> <span class="o">=</span> <span class="n">u_E_dot_kappa</span> <span class="o">/</span> <span class="n">EARTH_RADIUS_KM</span>  <span class="c1"># 1/s</span>
            <span class="n">dW_fermi_J_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_parallel_sq_si</span> <span class="o">*</span> <span class="n">u_E_dot_kappa_inv_s</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># SI</span>
            <span class="c1"># v_parallel is m/s, u_E_dot_kappa is 1/s</span>
            <span class="n">dW_fermi_J_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_parallel_sq</span> <span class="o">*</span> <span class="n">u_E_dot_kappa</span>

        <span class="n">dW_fermi</span> <span class="o">=</span> <span class="p">(</span><span class="n">dW_fermi_J_s</span> <span class="o">/</span> <span class="n">elementary_charge</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;dW_fermi&quot;</span><span class="p">)</span>

        <span class="c1"># --- Combine results ---</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                <span class="s2">&quot;dW_parallel&quot;</span><span class="p">:</span> <span class="n">dW_parallel</span><span class="p">,</span>
                <span class="s2">&quot;dW_betatron&quot;</span><span class="p">:</span> <span class="n">dW_betatron</span><span class="p">,</span>
                <span class="s2">&quot;dW_fermi&quot;</span><span class="p">:</span> <span class="n">dW_fermi</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">dW_total</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_parallel&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_betatron&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_fermi&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FLEKSTP.integrate_drift_accelerations">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.integrate_drift_accelerations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate_drift_accelerations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pid</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute plasma drift velocities and the associated rate of energy change in [eV/s].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_curvature_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">vg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gradient_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polarization_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_adiabatic_invariant</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_betatron_acceleration</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">UNIT_FACTOR</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">UNIT_FACTOR</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">vx</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">ke</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>  <span class="c1"># [eV]</span>

        <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">ke</span><span class="o">=</span><span class="n">ke</span><span class="p">,</span>
                <span class="n">b_mag</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">bx_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
                <span class="n">by_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
                <span class="n">bz_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">E_parallel</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">v_parallel</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the dot product of E with each drift velocity [eV/s]</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="c1"># Energy change from gradient drift</span>
            <span class="n">dWg</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
            <span class="c1"># Energy change from curvature drift</span>
            <span class="n">dWc</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
            <span class="c1"># Energy change from polarization drift</span>
            <span class="n">dWp</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
            <span class="c1"># Energy change from parallel acceleration</span>
            <span class="n">dW_parallel</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;E_parallel&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;v_parallel&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># 1. Calculate the time step &#39;dt&#39; between each measurement</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 2. Integrate each term using the trapezoidal rule and a cumulative sum</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="c1"># Integrated energy from gradient drift</span>
            <span class="n">Wg_integrated</span><span class="o">=</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dWg&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dWg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
            <span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="c1"># Integrated energy from curvature drift</span>
            <span class="n">Wc_integrated</span><span class="o">=</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dWc&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dWc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
            <span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="c1"># Integrated energy from polarization drift</span>
            <span class="n">Wp_integrated</span><span class="o">=</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dWp&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dWp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
            <span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="c1"># Integrated energy from parallel acceleration</span>
            <span class="n">W_parallel_integrated</span><span class="o">=</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_parallel&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_parallel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="c1"># Also integrate the betatron term if it exists</span>
            <span class="n">W_betatron_integrated</span><span class="o">=</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_betatron&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dW_betatron&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Let&#39;s also create a column for the total integrated energy change</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">W_total_integrated</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Wg_integrated&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Wc_integrated&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Wp_integrated&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;W_parallel_integrated&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;W_betatron_integrated&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ke&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Wg_integrated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Wc_integrated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Wp_integrated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;W_parallel_integrated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;W_betatron_integrated&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FLEKSTP.analyze_drifts">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.analyze_drifts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_drifts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pid</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">switchYZ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute plasma drift velocities and the associated rate of energy change in [eV/s].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="n">ve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ExB_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_curvature_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">vg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gradient_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polarization_drift</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">adiabaticity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adiabaticity_parameter</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_adiabatic_invariant</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_betatron_acceleration</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
        <span class="n">dke_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy_change_rate</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="c1"># Calculate the dot product of E with each drift velocity [eV/s]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">UNIT_FACTOR</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">UNIT_FACTOR</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">b_mag</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">bx_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
                <span class="n">by_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
                <span class="n">bz_u</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;b_mag&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">E_parallel</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">v_parallel</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by_u&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz_u&quot;</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the dot product of E with each drift velocity [eV/s]</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="c1"># Energy change from gradient drift</span>
            <span class="n">dWg</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
            <span class="c1"># Energy change from curvature drift</span>
            <span class="n">dWc</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
            <span class="c1"># Energy change from polarization drift</span>
            <span class="n">dWp</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ex&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ey&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ez&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
            <span class="c1"># Energy change from parallel acceleration</span>
            <span class="n">dW_parallel</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;E_parallel&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;v_parallel&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">UNIT_FACTOR</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_plot_velocity_subplot</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">vel_df</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">switchYZ</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">z_col</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper to plot a velocity subplot.&quot;&quot;&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">vel_df</span><span class="p">[</span><span class="n">x_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">x_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">switchYZ</span><span class="p">:</span>
                <span class="c1"># Swap y and z data for plotting</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">vel_df</span><span class="p">[</span><span class="n">z_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_col</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">vel_df</span><span class="p">[</span><span class="n">y_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">z_col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">vel_df</span><span class="p">[</span><span class="n">y_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_col</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">vel_df</span><span class="p">[</span><span class="n">z_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">z_col</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># --- 1. Raw Velocities ---</span>
        <span class="n">_plot_velocity_subplot</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">,</span> <span class="s2">&quot;V [km/s]&quot;</span><span class="p">,</span> <span class="n">switchYZ</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span>
        <span class="p">)</span>

        <span class="c1"># --- 2. Plasma Convection Drift (vex, vey, vez) ---</span>
        <span class="n">_plot_velocity_subplot</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="n">ve</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;$V_{\mathbf</span><span class="si">{E}</span><span class="s2">\times\mathbf</span><span class="si">{B}</span><span class="s2">}$ [km/s]&quot;</span><span class="p">,</span>
            <span class="n">switchYZ</span><span class="p">,</span>
            <span class="s2">&quot;vex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vey&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vez&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># --- 3. Plasma Gradient Drift (vgx, vgy, vgz) ---</span>
        <span class="n">_plot_velocity_subplot</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="n">vg</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;$V_{\nabla B}$ [km/s]&quot;</span><span class="p">,</span>
            <span class="n">switchYZ</span><span class="p">,</span>
            <span class="s2">&quot;vgx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vgy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vgz&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># --- 4. Plasma Curvature Drift (vcx, vcy, vcz) ---</span>
        <span class="n">_plot_velocity_subplot</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">vc</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$V_c$ [km/s]&quot;</span><span class="p">,</span> <span class="n">switchYZ</span><span class="p">,</span> <span class="s2">&quot;vcx&quot;</span><span class="p">,</span> <span class="s2">&quot;vcy&quot;</span><span class="p">,</span> <span class="s2">&quot;vcz&quot;</span>
        <span class="p">)</span>

        <span class="c1"># --- 5. Plasma Polarization Drift (vpx, vpy, vpz) ---</span>
        <span class="n">_plot_velocity_subplot</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">vp</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$V_p$ [km/s]&quot;</span><span class="p">,</span> <span class="n">switchYZ</span><span class="p">,</span> <span class="s2">&quot;vpx&quot;</span><span class="p">,</span> <span class="s2">&quot;vpy&quot;</span><span class="p">,</span> <span class="s2">&quot;vpz&quot;</span>
        <span class="p">)</span>

        <span class="c1"># --- 6. Rate of Energy Change (E dot V) ---</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;dWg&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$q \mathbf</span><span class="si">{E}</span><span class="s2"> \cdot \mathbf</span><span class="si">{V}</span><span class="s2">_{\nabla B}$&quot;</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;dWc&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$q \mathbf</span><span class="si">{E}</span><span class="s2"> \cdot \mathbf</span><span class="si">{V}</span><span class="s2">_</span><span class="si">{c}</span><span class="s2">$&quot;</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;dWp&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$q \mathbf</span><span class="si">{E}</span><span class="s2"> \cdot \mathbf</span><span class="si">{V}</span><span class="s2">_</span><span class="si">{p}</span><span class="s2">$&quot;</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;dW_parallel&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$q E_{\|} v_{\|}$&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;dW_betatron&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Betatron&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dke_dt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;dKE/dt&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy change rate</span><span class="se">\n</span><span class="s2"> [eV/s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">adiabaticity</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">adiabaticity</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">adiabaticity</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r_c / r_L$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.analyze_drifts_energy_change">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.analyze_drifts_energy_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_drifts_energy_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes and plots the energy changes for each term in the guiding center</span>
<span class="sd">        approximation.</span>

<span class="sd">        This method computes the parallel, Betatron, and Fermi accelerations using</span>
<span class="sd">        `get_energy_change_guiding_center`. It also calculates the total kinetic</span>
<span class="sd">        energy change and treats the difference between the kinetic energy change</span>
<span class="sd">        and the sum of the guiding center terms (dW_total) as the non-adiabatic term.</span>

<span class="sd">        The method generates a plot with four subplots:</span>
<span class="sd">        1. dW_parallel: Energy change due to parallel electric fields.</span>
<span class="sd">        2. dW_betatron: Energy change due to the Betatron effect.</span>
<span class="sd">        3. dW_fermi: Energy change due to Fermi acceleration.</span>
<span class="sd">        4. dW_total and Non-adiabatic term: The sum of the above terms compared</span>
<span class="sd">           with the non-adiabatic heating component.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID (Tuple[int, int]): The particle ID (cpu, id).</span>
<span class="sd">            outname (str, optional): If provided, the plot is saved to this</span>
<span class="sd">                                     filename instead of being shown. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- 1. Get Guiding Center Energy Changes ---</span>
        <span class="n">df_gc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy_change_guiding_center</span><span class="p">(</span><span class="n">pID</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">df_gc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="n">dW_parallel</span> <span class="o">=</span> <span class="n">df_gc</span><span class="p">[</span><span class="s2">&quot;dW_parallel&quot;</span><span class="p">]</span>
        <span class="n">dW_betatron</span> <span class="o">=</span> <span class="n">df_gc</span><span class="p">[</span><span class="s2">&quot;dW_betatron&quot;</span><span class="p">]</span>
        <span class="n">dW_fermi</span> <span class="o">=</span> <span class="n">df_gc</span><span class="p">[</span><span class="s2">&quot;dW_fermi&quot;</span><span class="p">]</span>
        <span class="n">dW_total</span> <span class="o">=</span> <span class="n">df_gc</span><span class="p">[</span><span class="s2">&quot;dW_total&quot;</span><span class="p">]</span>

        <span class="c1"># --- 2. Get Kinetic Energy Change Rate ---</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="n">dke_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy_change_rate</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>

        <span class="c1"># --- 3. Calculate Non-adiabatic Term ---</span>
        <span class="c1"># Ensure dke_dt is aligned with the time from df_gc if lengths differ</span>
        <span class="c1"># (though they should be the same)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dke_dt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dW_total</span><span class="p">):</span>
            <span class="c1"># This case should not happen if the underlying data is consistent.</span>
            <span class="c1"># Raise an error to prevent crashing later.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mismatch in length between kinetic energy and guiding center calculations: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;len(dke_dt)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dke_dt</span><span class="p">)</span><span class="si">}</span><span class="s2">, len(dW_total)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dW_total</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">non_adiabatic_term</span> <span class="o">=</span> <span class="n">dke_dt</span> <span class="o">-</span> <span class="n">dW_total</span>

        <span class="c1"># --- 4. Plotting ---</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Energy Change Analysis for Particle </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Subplots for individual energy change terms</span>
        <span class="n">plot_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">dW_parallel</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$dW_{\parallel}/dt$&quot;</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Parallel Acceleration&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">dW_betatron</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;$dW_</span><span class="si">{betatron}</span><span class="s2">/dt$&quot;</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Betatron Acceleration&quot;</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">dW_fermi</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;$dW_</span><span class="si">{fermi}</span><span class="s2">/dt$&quot;</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fermi Acceleration&quot;</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_configs</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate [eV/s]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># Subplot 4: dW_total and Non-adiabatic term</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dW_total</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$dW_</span><span class="si">{total}</span><span class="s2">/dt$ (GC)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span>
            <span class="n">non_adiabatic_term</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-adiabatic&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">dke_dt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;d(KE)/dt&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate [eV/s]&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Total and Non-Adiabatic Energy Change&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">right</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.analyze_drift">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.analyze_drift">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_drift</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">drift_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes a specific drift for a particle, plotting its velocity, the</span>
<span class="sd">        electric field, the energy change rate, and the integrated energy change.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID (tuple[int, int]): The particle ID (cpu, id).</span>
<span class="sd">            drift_type (str): The type of drift to analyze. Supported options are:</span>
<span class="sd">                              &#39;ExB&#39;, &#39;gradient&#39;, &#39;curvature&#39;, &#39;polarization&#39;.</span>
<span class="sd">            outname (str, optional): If provided, the plot is saved to this</span>
<span class="sd">                                      filename instead of being shown. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">drift_getters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ExB&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ExB_drift</span><span class="p">,</span>
            <span class="s2">&quot;gradient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gradient_drift</span><span class="p">,</span>
            <span class="s2">&quot;curvature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_curvature_drift</span><span class="p">,</span>
            <span class="s2">&quot;polarization&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polarization_drift</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">drift_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drift_getters</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown drift_type: &#39;</span><span class="si">{</span><span class="n">drift_type</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available options are </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">drift_getters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># 1. Get data</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="n">v_drift_df</span> <span class="o">=</span> <span class="n">drift_getters</span><span class="p">[</span><span class="n">drift_type</span><span class="p">](</span><span class="n">pt_lazy</span><span class="p">)</span>
        <span class="n">pt_df</span> <span class="o">=</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="c1"># Rename columns of v_drift_df to be generic for plotting</span>
        <span class="n">v_drift_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v_drift_x&quot;</span><span class="p">,</span> <span class="s2">&quot;v_drift_y&quot;</span><span class="p">,</span> <span class="s2">&quot;v_drift_z&quot;</span><span class="p">]</span>

        <span class="c1"># 2. Calculate energy change rate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># E[uV/m] * v[km/s] -&gt; (1e-6 V/m) * (1e3 m/s) = 1e-3 J/C/s</span>
            <span class="c1"># This is the rate of energy change in eV/s</span>
            <span class="n">UNIT_FACTOR</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">UNIT_FACTOR</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">d_W</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_drift_df</span><span class="p">[</span><span class="s2">&quot;v_drift_x&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_drift_df</span><span class="p">[</span><span class="s2">&quot;v_drift_y&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_drift_df</span><span class="p">[</span><span class="s2">&quot;v_drift_z&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">UNIT_FACTOR</span>
        <span class="n">d_W</span> <span class="o">=</span> <span class="n">d_W</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;d_W&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Integrate energy change using cumulative trapezoidal rule</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W_integrated</span> <span class="o">=</span> <span class="p">((</span><span class="n">d_W</span> <span class="o">+</span> <span class="n">d_W</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W_integrated</span> <span class="o">=</span> <span class="n">W_integrated</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;W_integrated&quot;</span><span class="p">)</span>

        <span class="c1"># 4. Plotting</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">v_unit_label</span> <span class="o">=</span> <span class="s2">&quot;km/s&quot;</span>
            <span class="n">e_unit_label</span> <span class="o">=</span> <span class="s2">&quot;μV/m&quot;</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.unit == &quot;SI&quot;</span>
            <span class="n">v_unit_label</span> <span class="o">=</span> <span class="s2">&quot;m/s&quot;</span>
            <span class="n">e_unit_label</span> <span class="o">=</span> <span class="s2">&quot;V/m&quot;</span>

        <span class="c1"># Plot 1: Drift velocity</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">v_drift_df</span><span class="p">[</span><span class="s2">&quot;v_drift_x&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_x$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">v_drift_df</span><span class="p">[</span><span class="s2">&quot;v_drift_y&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_y$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">v_drift_df</span><span class="p">[</span><span class="s2">&quot;v_drift_z&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_z$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$V_</span><span class="se">{{</span><span class="si">{</span><span class="n">drift_type</span><span class="si">}</span><span class="se">}}</span><span class="s2">$ [</span><span class="si">{</span><span class="n">v_unit_label</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># Plot 2: Electric field</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E_x$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E_y$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E_z$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E [</span><span class="si">{</span><span class="n">e_unit_label</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># Plot 3: Energy change rate</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">d_W</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy Change Rate</span><span class="se">\n</span><span class="s2">[eV/s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># Plot 4: Integrated energy change</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">W_integrated</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Integrated Energy [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis of </span><span class="si">{</span><span class="n">drift_type</span><span class="si">}</span><span class="s2"> Drift for Particle </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">right</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.plot_work_energy_verification">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.plot_work_energy_verification">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_work_energy_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the work-energy theorem for a particle by plotting the rate of</span>
<span class="sd">        change of kinetic energy against the work rate done by the electric field.</span>
<span class="sd">        It also plots the integrated change in kinetic energy versus the total</span>
<span class="sd">        work done.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID (Tuple[int, int]): The particle ID (cpu, id).</span>
<span class="sd">            outname (str, optional): If provided, the plot is saved to this</span>
<span class="sd">                                     filename. Defaults to None (displays plot).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="c1"># Collect necessary columns once to improve performance.</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;ex&quot;</span><span class="p">,</span> <span class="s2">&quot;ey&quot;</span><span class="p">,</span> <span class="s2">&quot;ez&quot;</span><span class="p">]</span>
        <span class="n">pt_df</span> <span class="o">=</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">required_cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="c1"># 1. Calculate the rate of change of kinetic energy (d(KE)/dt)</span>
        <span class="n">ke</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">(</span><span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">],</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">],</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">])</span>
        <span class="n">dke_dt</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;dke_dt&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">ke</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>

        <span class="c1"># 2. Calculate the rate of work done by the electric field (q * E.v)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="c1"># E[uV/m] * v[km/s] -&gt; (1e-6 V/m) * (1e3 m/s) = 1e-3 J/C/s</span>
            <span class="c1"># To get eV/s, multiply by (1 / elementary_charge)</span>
            <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
            <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">work_rate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pt_df</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">unit_factor</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span>
            <span class="o">/</span> <span class="n">elementary_charge</span>
        <span class="p">)</span>
        <span class="n">work_rate</span> <span class="o">=</span> <span class="n">work_rate</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;work_rate&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Integrate both rates over time</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Integrated change in kinetic energy</span>
        <span class="n">delta_ke_integrated</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">dke_dt</span> <span class="o">+</span> <span class="n">dke_dt</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Integrated work done</span>
        <span class="n">work_done_integrated</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">work_rate</span> <span class="o">+</span> <span class="n">work_rate</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 4. Plotting</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Work-Energy Verification for Particle </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Panel 1: Rates of change</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dke_dt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;d(KE)/dt&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">work_rate</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;q E⋅v (Work Rate)&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate [eV/s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rate of Kinetic Energy Change vs. Work Rate&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="c1"># Panel 2: Integrated quantities</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">delta_ke_integrated</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ΔKE (Integrated)&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span>
            <span class="n">work_done_integrated</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total Work Done&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="s2">&quot;Integrated Kinetic Energy Change vs. Total Work Done&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">right</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.find_shock_crossing_time">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.find_shock_crossing_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_shock_crossing_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">b_threshold_factor</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the shock crossing time for a single particle.</span>

<span class="sd">        The shock is identified by finding the first rate of change in the</span>
<span class="sd">        magnetic field magnitude that exceeds a threshold, which signifies a</span>
<span class="sd">        rapid transition between the upstream and downstream regions.</span>

<span class="sd">        Args:</span>
<span class="sd">            pid: particle index.</span>
<span class="sd">            b_threshold_factor (float): A multiplier for the standard deviation of</span>
<span class="sd">                                        the B-field derivative. A larger value makes</span>
<span class="sd">                                        the detection less sensitive to minor</span>
<span class="sd">                                        fluctuations. Defaults to 2.5.</span>
<span class="sd">            verbose (bool): If True, prints diagnostic information. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or None: The time of the shock crossing in seconds. Returns None if</span>
<span class="sd">                        no significant crossing is detected based on the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- 1. Data Preparation ---</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="n">t_and_b_mag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">b_mag</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bz&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;b_mag&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t_and_b_mag</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="n">t_and_b_mag</span><span class="p">[</span><span class="s2">&quot;b_mag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Ensure there are enough data points for a derivative calculation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not enough data points to reliably find a shock.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># --- 2. Calculate the Rate of Change ---</span>
        <span class="c1"># Use np.gradient to find the time derivative of the B-field magnitude.</span>
        <span class="c1"># This correctly handles potentially uneven time steps.</span>
        <span class="n">db_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">b_mag</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">abs_db_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">db_dt</span><span class="p">)</span>

        <span class="c1"># --- 3. Dynamic Thresholding for Spike Detection ---</span>
        <span class="c1"># Set a threshold to distinguish significant spikes from noise.</span>
        <span class="n">mean_db_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">abs_db_dt</span><span class="p">)</span>
        <span class="n">std_db_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">abs_db_dt</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">mean_db_dt</span> <span class="o">+</span> <span class="n">b_threshold_factor</span> <span class="o">*</span> <span class="n">std_db_dt</span>

        <span class="c1"># Find all time indices where the derivative exceeds this threshold</span>
        <span class="n">candidate_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">abs_db_dt</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># --- 4. Identify the Most Likely Crossing Time ---</span>
        <span class="c1"># If no points are above the threshold, no shock was detected.</span>
        <span class="k">if</span> <span class="n">candidate_indices</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No B-field change above the threshold (</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nT/s) was found.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">shock_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">candidate_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">shock_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">shock_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shock crossing detected at t = </span><span class="si">{</span><span class="n">shock_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shock_time</span></div>


<div class="viewcode-block" id="FLEKSTP.get_shock_up_down_states">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.get_shock_up_down_states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shock_up_down_states</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pids</span><span class="p">,</span>
        <span class="n">delta_t_up</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
        <span class="n">delta_t_down</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span>
        <span class="n">b_threshold_factor</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes particles to find their state upstream and downstream of a shock.</span>

<span class="sd">        This function iterates through a list of particle IDs. For each particle, it</span>
<span class="sd">        first identifies the shock crossing time. It then calculates specific upstream</span>
<span class="sd">        and downstream time points based on this crossing. Finally, it interpolates</span>
<span class="sd">        the particle&#39;s full state (position, velocity, fields) at these two points</span>
<span class="sd">        and collects the results.</span>

<span class="sd">        Args:</span>
<span class="sd">            pids (list): A list of particle IDs (e.g., [(0, 1), (0, 2), ...]) to process.</span>
<span class="sd">            delta_t_up (float): The time in seconds *before* the shock crossing to define</span>
<span class="sd">                                the upstream point. Defaults to 20.0.</span>
<span class="sd">            delta_t_down (float): The time in seconds *after* the shock crossing to define</span>
<span class="sd">                                  the downstream point. Defaults to 40.0.</span>
<span class="sd">            b_threshold_factor (float): The sensitivity factor for shock detection, passed to</span>
<span class="sd">                                        `find_shock_crossing_time`. Defaults to 2.5.</span>
<span class="sd">            verbose (bool): If True, prints progress and individual shock detection times.</span>
<span class="sd">                            Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[pl.DataFrame, pl.DataFrame]: A tuple containing two Polars DataFrames:</span>
<span class="sd">                - The first DataFrame contains the states of all valid particles at their</span>
<span class="sd">                  respective upstream times.</span>
<span class="sd">                - The second DataFrame contains the states of all valid particles at their</span>
<span class="sd">                  respective downstream times.</span>
<span class="sd">            Each DataFrame includes the original particle ID (`pid_rank`, `pid_idx`), the</span>
<span class="sd">            shock crossing time (`t_cross`), and the interpolated physical quantities.</span>
<span class="sd">            Returns (None, None) if no particles with a valid shock crossing are found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Starting upstream/downstream analysis for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span><span class="si">}</span><span class="s2"> particles...&quot;</span>
            <span class="p">)</span>
        <span class="n">upstream_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">downstream_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_particles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  ...processing particle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_particles</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

            <span class="c1"># 1. Find the shock crossing time for the current particle</span>
            <span class="n">t_cross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_shock_crossing_time</span><span class="p">(</span>
                <span class="n">pid</span><span class="p">,</span> <span class="n">b_threshold_factor</span><span class="o">=</span><span class="n">b_threshold_factor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="c1"># 2. Skip particle if no shock crossing is found</span>
            <span class="k">if</span> <span class="n">t_cross</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  -&gt; No shock crossing found for particle </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                    <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  -&gt; Shock found for </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> at t=</span><span class="si">{</span><span class="n">t_cross</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.&quot;</span><span class="p">)</span>

            <span class="c1"># 3. Define the upstream and downstream time points</span>
            <span class="n">t_upstream</span> <span class="o">=</span> <span class="n">t_cross</span> <span class="o">-</span> <span class="n">delta_t_up</span>
            <span class="n">t_downstream</span> <span class="o">=</span> <span class="n">t_cross</span> <span class="o">+</span> <span class="n">delta_t_down</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 4. Interpolate the particle&#39;s state at the specified times</span>
                <span class="c1"># The result is a 2-row Polars DataFrame</span>
                <span class="n">interpolated_states</span> <span class="o">=</span> <span class="n">interpolate_at_times</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">pid</span><span class="p">],</span> <span class="n">times_to_interpolate</span><span class="o">=</span><span class="p">[</span><span class="n">t_upstream</span><span class="p">,</span> <span class="n">t_downstream</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># Ensure we got two valid rows back</span>
                <span class="k">if</span> <span class="n">interpolated_states</span><span class="o">.</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;  -&gt; Interpolation failed for </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># 5. Separate and enrich the data for collection</span>
                <span class="n">up_state</span> <span class="o">=</span> <span class="n">interpolated_states</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">down_state</span> <span class="o">=</span> <span class="n">interpolated_states</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Add metadata (pid and shock time) to each state DataFrame</span>
                <span class="c1"># This makes later analysis much easier</span>
                <span class="n">up_state</span> <span class="o">=</span> <span class="n">up_state</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pid_rank&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pid_idx&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">t_cross</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;t_cross&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">down_state</span> <span class="o">=</span> <span class="n">down_state</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pid_rank&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pid_idx&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">t_cross</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;t_cross&quot;</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="n">upstream_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up_state</span><span class="p">)</span>
                <span class="n">downstream_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">down_state</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Catch any other errors during interpolation (e.g., times out of bounds)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  -&gt; An error occurred for particle </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                    <span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># 6. Finalize the results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">upstream_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished processing. No valid shock-crossing particles found.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Concatenate all the individual DataFrames into two final ones</span>
        <span class="n">final_upstream_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">upstream_states</span><span class="p">)</span>
        <span class="n">final_downstream_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">downstream_states</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished processing. Found </span><span class="si">{</span><span class="n">final_upstream_df</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> valid particles.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">final_upstream_df</span><span class="p">,</span> <span class="n">final_downstream_df</span></div>


<div class="viewcode-block" id="FLEKSTP._get_HT_frame">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._get_HT_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_HT_frame</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">upstream_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">downstream_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the de Hoffmann-Teller frame velocity and the shock normal vector</span>
<span class="sd">        using the method from Sonnerup et al. [2006], which minimizes the</span>
<span class="sd">        residual electric field.</span>

<span class="sd">        Args:</span>
<span class="sd">            upstream_df (pl.DataFrame): DataFrame with upstream particle states.</span>
<span class="sd">            downstream_df (pl.DataFrame): DataFrame with downstream particle states.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[np.ndarray | None, np.ndarray | None]: A tuple containing:</span>
<span class="sd">                - V_HT (np.ndarray | None): The de Hoffmann-Teller velocity vector</span>
<span class="sd">                  in [km/s] if successful, otherwise None.</span>
<span class="sd">                - shock_normal (np.ndarray | None): The estimated shock normal</span>
<span class="sd">                  vector if successful, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_states</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">upstream_df</span><span class="p">,</span> <span class="n">downstream_df</span><span class="p">])</span>

        <span class="c1"># Extract E and B fields, converting to SI units if necessary</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">all_states</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;ex&quot;</span><span class="p">,</span> <span class="s2">&quot;ey&quot;</span><span class="p">,</span> <span class="s2">&quot;ez&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">all_states</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="mf">1e-6</span>  <span class="c1"># uV/m to V/m</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="mf">1e-9</span>  <span class="c1"># nT to T</span>

        <span class="c1"># --- Calculate V_HT by solving M * V_HT = C ---</span>
        <span class="c1"># M_ij = sum(B^2 * delta_ij - B_i * B_j)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">B</span><span class="p">)</span>

        <span class="c1"># C = sum(E x B)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">B</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">V_HT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>  <span class="c1"># Result is in m/s</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Could not determine de Hoffmann-Teller velocity. &quot;</span>
                <span class="s2">&quot;The matrix M is singular, which can happen if all B vectors are parallel.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Convert V_HT back to km/s if using planetary units</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">V_HT</span> <span class="o">/=</span> <span class="mf">1e3</span>

        <span class="c1"># --- Calculate shock normal using magnetic coplanarity ---</span>
        <span class="n">B_up_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">upstream_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">B_down_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">downstream_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">B_up_avg</span> <span class="o">-</span> <span class="n">B_down_avg</span>
        <span class="n">n_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">B_up_avg</span><span class="p">,</span> <span class="n">B_down_avg</span><span class="p">)</span>
        <span class="n">shock_normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">n_c</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">shock_normal</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="n">shock_normal</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Could not determine shock normal via magnetic coplanarity. &quot;</span>
                <span class="s2">&quot;Upstream and downstream average B fields may be parallel.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">V_HT</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">V_HT</span><span class="p">,</span> <span class="n">shock_normal</span></div>


<div class="viewcode-block" id="FLEKSTP.analyze_in_HT_frame">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.analyze_in_HT_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_in_HT_frame</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">outname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes a particle&#39;s trajectory in the de Hoffmann-Teller (HT) frame.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Finds the shock crossing and determines the upstream and downstream states.</span>
<span class="sd">        2. Calculates the de Hoffmann-Teller velocity (V_HT) and the shock normal.</span>
<span class="sd">        3. Transforms the particle&#39;s velocity and the electric/magnetic fields</span>
<span class="sd">           into the HT frame.</span>
<span class="sd">        4. In this frame, the energy gain is a direct measure of non-ideal</span>
<span class="sd">           acceleration. It calculates and plots this energy gain.</span>
<span class="sd">        5. Generates a summary plot of the analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID (Tuple[int, int]): The particle ID (cpu, id) to analyze.</span>
<span class="sd">            outname (str, optional): If provided, the plot is saved to this</span>
<span class="sd">                                     filename. Defaults to None (displays plot).</span>
<span class="sd">            verbose (bool, optional): If True, prints diagnostic information.</span>
<span class="sd">                                      Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Get upstream and downstream states for the particle</span>
        <span class="n">upstream_df</span><span class="p">,</span> <span class="n">downstream_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shock_up_down_states</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pID</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">upstream_df</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">upstream_df</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
            <span class="ow">or</span> <span class="n">downstream_df</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="n">downstream_df</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find valid upstream/downstream states for particle </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># 2. Calculate the HT frame velocity and shock normal</span>
        <span class="n">V_HT</span><span class="p">,</span> <span class="n">shock_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_HT_frame</span><span class="p">(</span><span class="n">upstream_df</span><span class="p">,</span> <span class="n">downstream_df</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">V_HT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not determine the de Hoffmann-Teller frame for particle </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Determined V_HT = </span><span class="si">{</span><span class="n">V_HT</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shock_normal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated shock normal n = </span><span class="si">{</span><span class="n">shock_normal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Get the full particle trajectory</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt_lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># 4. Transform trajectory data into the HT frame</span>
        <span class="n">v_vec</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">e_vec</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;ex&quot;</span><span class="p">,</span> <span class="s2">&quot;ey&quot;</span><span class="p">,</span> <span class="s2">&quot;ez&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">b_vec</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Velocity in HT frame</span>
        <span class="n">v_prime</span> <span class="o">=</span> <span class="n">v_vec</span> <span class="o">-</span> <span class="n">V_HT</span>

        <span class="c1"># Electric field in HT frame: E&#39; = E + V_HT x B</span>
        <span class="n">V_HT_si</span> <span class="o">=</span> <span class="n">V_HT</span>
        <span class="n">b_vec_si</span> <span class="o">=</span> <span class="n">b_vec</span>
        <span class="n">e_vec_si</span> <span class="o">=</span> <span class="n">e_vec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">V_HT_si</span> <span class="o">=</span> <span class="n">V_HT</span> <span class="o">*</span> <span class="mf">1e3</span>  <span class="c1"># km/s to m/s</span>
            <span class="n">b_vec_si</span> <span class="o">=</span> <span class="n">b_vec</span> <span class="o">*</span> <span class="mf">1e-9</span>  <span class="c1"># nT to T</span>
            <span class="n">e_vec_si</span> <span class="o">=</span> <span class="n">e_vec</span> <span class="o">*</span> <span class="mf">1e-6</span>  <span class="c1"># uV/m to V/m</span>

        <span class="n">vht_cross_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">V_HT_si</span><span class="p">,</span> <span class="n">b_vec_si</span><span class="p">)</span>
        <span class="n">e_prime_si</span> <span class="o">=</span> <span class="n">e_vec_si</span> <span class="o">+</span> <span class="n">vht_cross_b</span>

        <span class="n">e_prime</span> <span class="o">=</span> <span class="n">e_prime_si</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">e_prime</span> <span class="o">=</span> <span class="n">e_prime_si</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># Convert back to uV/m for plotting</span>

        <span class="c1"># Add transformed fields to the DataFrame</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;vx_ht&quot;</span><span class="p">,</span> <span class="n">v_prime</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;vy_ht&quot;</span><span class="p">,</span> <span class="n">v_prime</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;vz_ht&quot;</span><span class="p">,</span> <span class="n">v_prime</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;ex_ht&quot;</span><span class="p">,</span> <span class="n">e_prime</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;ey_ht&quot;</span><span class="p">,</span> <span class="n">e_prime</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;ez_ht&quot;</span><span class="p">,</span> <span class="n">e_prime</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># 5. Calculate energy and its change rate in the HT frame</span>
        <span class="n">ke_ht</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">(</span><span class="n">v_prime</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">v_prime</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">v_prime</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">dke_dt_ht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">ke_ht</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="c1"># Theoretical energy gain: (q/e) * E&#39; . V&#39;</span>
        <span class="n">v_prime_si</span> <span class="o">=</span> <span class="n">v_prime</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">v_prime_si</span> <span class="o">=</span> <span class="n">v_prime</span> <span class="o">*</span> <span class="mf">1e3</span>  <span class="c1"># km/s to m/s</span>

        <span class="n">e_dot_v_ht_j_per_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_prime_si</span> <span class="o">*</span> <span class="n">v_prime_si</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">e_dot_v_ht</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">elementary_charge</span><span class="p">)</span> <span class="o">*</span> <span class="n">e_dot_v_ht_j_per_c</span>

        <span class="c1"># 6. Plotting</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;De Hoffmann-Teller Frame Analysis for Particle </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span>
        <span class="p">)</span>

        <span class="n">time_plot</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="n">v_unit</span> <span class="o">=</span> <span class="s2">&quot;km/s&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span> <span class="k">else</span> <span class="s2">&quot;m/s&quot;</span>
        <span class="n">e_unit</span> <span class="o">=</span> <span class="s2">&quot;μV/m&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span> <span class="k">else</span> <span class="s2">&quot;V/m&quot;</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx_ht&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V&#39;_x$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy_ht&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V&#39;_y$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz_ht&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V&#39;_z$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;V&#39; [</span><span class="si">{</span><span class="n">v_unit</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Velocity in HT Frame&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ex_ht&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E&#39;_x$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey_ht&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E&#39;_y$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez_ht&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E&#39;_z$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;E&#39; [</span><span class="si">{</span><span class="n">e_unit</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Electric Field in HT Frame&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">ke_ht</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;KE&#39;&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;KE&#39; [eV]&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Kinetic Energy in HT Frame&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">dke_dt_ht</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;d(KE&#39;)/dt&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_plot</span><span class="p">,</span> <span class="n">e_dot_v_ht</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;q E&#39; ⋅ V&#39;&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate [eV/s]&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Non-ideal Energy Gain Rate&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outname</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Saved HT analysis plot to </span><span class="si">{</span><span class="n">outname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.plot_trajectory">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.plot_trajectory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_trajectory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">fscaling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">smoothing_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">t_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">t_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shock_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;quick&quot;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">switchYZ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">splitYZ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the trajectory and velocities of the particle pID.</span>

<span class="sd">        Example:</span>
<span class="sd">        &gt;&gt;&gt; tp.plot_trajectory((3,15))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">plot_data</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">winter</span><span class="p">(</span><span class="n">tNorm</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">plot_vector</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">irow</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                <span class="n">plot_data</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error plotting trajectory for </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="n">tNorm</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">t</span> <span class="k">if</span> <span class="n">xaxis</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span> <span class="k">else</span> <span class="n">pt</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="n">yaxis</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;xv&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;velocity&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>

            <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;vx&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;vy&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;vz&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;quick&quot;</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Default for X, V</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># additional B field</span>
                <span class="n">nrow</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>  <span class="c1"># additional B and E field</span>
                <span class="n">nrow</span> <span class="o">=</span> <span class="mi">5</span>

            <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Plot trajectories</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]):</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;y&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;z&quot;</span>
                <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">x_label</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="n">y_label</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">pt</span><span class="p">[</span><span class="n">x_label</span><span class="p">],</span>
                    <span class="n">pt</span><span class="p">[</span><span class="n">y_label</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">winter</span><span class="p">(</span><span class="n">tNorm</span><span class="p">),</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

            <span class="n">plot_vector</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plot_vector</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">],</span>
                <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;</span> <span class="n">Indices</span><span class="o">.</span><span class="n">BX</span><span class="p">:</span>
                <span class="n">plot_vector</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">],</span>
                    <span class="mi">3</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nReal</span> <span class="o">&gt;</span> <span class="n">Indices</span><span class="o">.</span><span class="n">EX</span><span class="p">:</span>
                <span class="n">plot_vector</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">,</span> <span class="s2">&quot;ey&quot;</span><span class="p">,</span> <span class="s2">&quot;ez&quot;</span><span class="p">],</span>
                    <span class="mi">4</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing particle ID: </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                    <span class="n">stop</span><span class="o">=</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                    <span class="n">step</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">interpolate_at_times</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

            <span class="c1"># --- Time Interval Selection using Polars ---</span>
            <span class="k">if</span> <span class="n">t_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">t_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">t_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;beginning&quot;</span>
                <span class="n">end_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_end</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">t_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;end&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slicing data from t=</span><span class="si">{</span><span class="n">start_str</span><span class="si">}</span><span class="s2"> s to t=</span><span class="si">{</span><span class="n">end_str</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>

                <span class="c1"># Build a filter expression for the given time range</span>
                <span class="k">if</span> <span class="n">t_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">t_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">t_end</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">t_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">t_start</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># t_end must be not None here</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">t_end</span><span class="p">)</span>

            <span class="c1"># --- Data Extraction ---</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [s]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [RE]</span>
                <span class="n">vx</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [km/s]</span>
                <span class="n">bx</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [nT]</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># [mV/m]</span>
                <span class="k">if</span> <span class="n">switchYZ</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [RE]</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [RE]</span>
                    <span class="n">vy</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [km/s]</span>
                    <span class="n">vz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [km/s]</span>
                    <span class="n">by</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [nT]</span>
                    <span class="n">bz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [nT]</span>
                    <span class="n">ey</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># [mV/m]</span>
                    <span class="n">ez</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># [mV/m]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [RE]</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [RE]</span>
                    <span class="n">vy</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [km/s]</span>
                    <span class="n">vz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [km/s]</span>
                    <span class="n">by</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [nT]</span>
                    <span class="n">bz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [nT]</span>
                    <span class="n">ey</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># [mV/m]</span>
                    <span class="n">ez</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># [mV/m]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [s]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m]</span>
                <span class="n">vx</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m/s]</span>
                <span class="n">bx</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [T]</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [V/m]</span>
                <span class="k">if</span> <span class="n">switchYZ</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m]</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m]</span>
                    <span class="n">vy</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m/s]</span>
                    <span class="n">vz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m/s]</span>
                    <span class="n">by</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [T]</span>
                    <span class="n">bz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [T]</span>
                    <span class="n">ey</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [V/m]</span>
                    <span class="n">ez</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [V/m]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m]</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m]</span>
                    <span class="n">vy</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m/s]</span>
                    <span class="n">vz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [m/s]</span>
                    <span class="n">by</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [T]</span>
                    <span class="n">bz</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [T]</span>
                    <span class="n">ey</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [V/m]</span>
                    <span class="n">ez</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;ez&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># [V/m]</span>

            <span class="c1"># --- Derived Quantities Calculation ---</span>

            <span class="c1"># Kinetic Energy</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kinetic_energy</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>  <span class="c1"># [eV]</span>

            <span class="c1"># --- Velocity Smoothing and Envelope Calculation ---</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">smoothing_window</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">smoothing_window</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Applying moving average with window size: </span><span class="si">{</span><span class="n">smoothing_window</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Convert numpy arrays to polars Series for easy rolling calculations</span>
                <span class="n">vx_s</span><span class="p">,</span> <span class="n">vy_s</span><span class="p">,</span> <span class="n">vz_s</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vx</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vy</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vz</span><span class="p">)</span>
                <span class="n">ke_s</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>

                <span class="c1"># Calculate moving average (the smoothed line)</span>
                <span class="n">vx_smooth</span> <span class="o">=</span> <span class="n">vx_s</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vy_smooth</span> <span class="o">=</span> <span class="n">vy_s</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vz_smooth</span> <span class="o">=</span> <span class="n">vz_s</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">ke_smooth</span> <span class="o">=</span> <span class="n">ke_s</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="c1"># Calculate min/max envelopes</span>
                <span class="n">vx_min_env</span> <span class="o">=</span> <span class="n">vx_s</span><span class="o">.</span><span class="n">rolling_min</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vx_max_env</span> <span class="o">=</span> <span class="n">vx_s</span><span class="o">.</span><span class="n">rolling_max</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vy_min_env</span> <span class="o">=</span> <span class="n">vy_s</span><span class="o">.</span><span class="n">rolling_min</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vy_max_env</span> <span class="o">=</span> <span class="n">vy_s</span><span class="o">.</span><span class="n">rolling_max</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vz_min_env</span> <span class="o">=</span> <span class="n">vz_s</span><span class="o">.</span><span class="n">rolling_min</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">vz_max_env</span> <span class="o">=</span> <span class="n">vz_s</span><span class="o">.</span><span class="n">rolling_max</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>

                <span class="n">ke_min_env</span> <span class="o">=</span> <span class="n">ke_s</span><span class="o">.</span><span class="n">rolling_min</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">ke_max_env</span> <span class="o">=</span> <span class="n">ke_s</span><span class="o">.</span><span class="n">rolling_max</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>

            <span class="n">v_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">b_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">e_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ez</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># Calculate magnitudes of vectors</span>
            <span class="n">v_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">b_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">e_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Pitch Angle Calculation</span>
            <span class="n">v_dot_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_vec</span> <span class="o">*</span> <span class="n">b_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>
            <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_mag</span> <span class="o">*</span> <span class="n">b_mag</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_alpha</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">pitch_angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_alpha</span><span class="p">)</span>
            <span class="n">pitch_angle</span> <span class="o">=</span> <span class="n">pitch_angle_rad</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                <span class="c1"># Magnetic Field Energy Density Calculation</span>
                <span class="n">U_B</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_mag</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mu_0</span> <span class="o">*</span> <span class="n">elementary_charge</span><span class="p">)</span>  <span class="c1"># [eV/m^3]</span>
                <span class="c1"># Electric Field Energy Density Calculation</span>
                <span class="n">U_E</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mf">0.5</span> <span class="o">*</span> <span class="n">epsilon_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_mag</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">elementary_charge</span>
                <span class="p">)</span>  <span class="c1"># [eV/m^3]</span>
                <span class="c1"># First Adiabatic Invariant (mu) Calculation</span>
                <span class="c1"># mu = mv_perp^2 / 2B.  v_perp = v * sin(alpha)</span>
                <span class="c1"># Ensure units are SI: v [m/s], B [T]</span>
                <span class="c1"># Perpendicular velocity in SI units [m/s]</span>
                <span class="n">v_perp</span> <span class="o">=</span> <span class="n">v_mag</span> <span class="o">*</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch_angle_rad</span><span class="p">)</span>
                <span class="c1"># Calculate mu, handle potential division by zero in B</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b_mag</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>  <span class="c1"># [J/T]</span>
                <span class="c1"># Gyrofrequency in Hz</span>
                <span class="n">gyro_freq</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">elementary_charge</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">)</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
                    <span class="o">*</span> <span class="mf">1e-9</span>
                    <span class="o">/</span> <span class="n">fscaling</span>
                <span class="p">)</span>
                <span class="c1"># Gyroradius in km</span>
                <span class="n">gyro_radius</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">elementary_charge</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">fscaling</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                <span class="c1"># Magnetic Field Energy Density Calculation</span>
                <span class="n">U_B</span> <span class="o">=</span> <span class="n">b_mag</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mu_0</span> <span class="o">*</span> <span class="n">elementary_charge</span><span class="p">)</span>  <span class="c1"># [eV/m^3]</span>
                <span class="c1"># Electric Field Energy Density Calculation</span>
                <span class="n">U_E</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">epsilon_0</span> <span class="o">*</span> <span class="n">e_mag</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">elementary_charge</span>  <span class="c1"># [eV/m^3]</span>
                <span class="c1"># First Adiabatic Invariant (mu) Calculation</span>
                <span class="n">v_perp</span> <span class="o">=</span> <span class="n">v_mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch_angle_rad</span><span class="p">)</span>
                <span class="c1"># Calculate mu, handle potential division by zero in B</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">b_mag</span>  <span class="c1"># [J/T]</span>
                <span class="c1"># Gyrofrequency in Hz</span>
                <span class="n">gyro_freq</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">elementary_charge</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span> <span class="o">/</span> <span class="n">fscaling</span>
                <span class="p">)</span>
                <span class="c1"># Gyroradius in km</span>
                <span class="n">gyro_radius</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">v_perp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">elementary_charge</span> <span class="o">*</span> <span class="n">b_mag</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">fscaling</span>
                <span class="p">)</span>

            <span class="c1"># --- Plotting ---</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Panel 0: Particle Location</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">splitYZ</span><span class="p">:</span>
                <span class="n">ax0_twin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">ax0_twin</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
                <span class="n">ax0_twin</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;X [$R_E$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax0_twin</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Z [$R_E$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;X [m]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax0_twin</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Z [m]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Location [$R_E$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Location [m]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>

            <span class="c1"># Panel 1: Particle Velocity</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V [km/s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V [m/s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

            <span class="c1"># If smoothing is enabled, plot the smoothed lines and envelopes</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">smoothing_window</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">smoothing_window</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># Plot smoothed lines with a thicker, more prominent style</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vx_smooth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_x$&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">vy_smooth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_y$&quot;</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">vz_smooth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_z$&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Shade the area between the min and max envelopes</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">vx_min_env</span><span class="p">,</span> <span class="n">vx_max_env</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">vy_min_env</span><span class="p">,</span> <span class="n">vy_max_env</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">vz_min_env</span><span class="p">,</span> <span class="n">vz_max_env</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_x$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_y$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_z$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

            <span class="c1"># Panel 2: Kinetic Energy</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;KE [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">smoothing_window</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smoothing_window</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">smoothing_window</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">ke_smooth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:brown&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;KE (smooth)&quot;</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">ke_min_env</span><span class="p">,</span> <span class="n">ke_max_env</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;KE&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:brown&quot;</span><span class="p">)</span>

            <span class="c1"># Panel 3: Field Energy Densities (on twin axes)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">U_B</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$U_B$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$U_B$ [eV/m$^3$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">)</span>

            <span class="n">ax3_twin</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">ax3_twin</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">U_E</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$U_E$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">)</span>
            <span class="n">ax3_twin</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$U_E$ [eV/m$^3$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">)</span>
            <span class="n">ax3_twin</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">)</span>

            <span class="c1"># Panel 4: Magnetic Field</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$B_x$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$B_y$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bz</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$B_z$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">b_mag</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$B$&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;B [nT]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;B [T]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

            <span class="c1"># Panel 5: Electric Field</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E_x$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E_y$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$E_z$&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;E [mV/m]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;E [V/m]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

            <span class="c1"># Panel 6: Pitch Angle</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pitch_angle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:brown&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha$ [$^\circ$]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>

            <span class="c1"># Create segments for the line</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">pitch_angle</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Create a LineCollection, coloring by gyroradius</span>
            <span class="n">norm_rg</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">gyro_radius</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">gyro_radius</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">lc_rg</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cividis&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_rg</span><span class="p">)</span>
            <span class="n">lc_rg</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">gyro_radius</span><span class="p">)</span>
            <span class="n">lc_rg</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">line_rg</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc_rg</span><span class="p">)</span>
            <span class="c1"># Add a color bar</span>
            <span class="n">cbar_rg</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">line_rg</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">pad</span><span class="o">=-</span><span class="mf">0.051</span><span class="p">)</span>
            <span class="n">cbar_rg</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r_L$ [km]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

            <span class="c1"># Panel 7: First Adiabatic Invariant</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:brown&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu$ [J/T]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>  <span class="c1"># mu can vary, log scale is often useful</span>
            <span class="c1"># Create segments for the line</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Create a LineCollection, coloring by gyrofrequency</span>
            <span class="n">norm_gf</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">gyro_freq</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">gyro_freq</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">lc_gf</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_gf</span><span class="p">)</span>
            <span class="n">lc_gf</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">gyro_freq</span><span class="p">)</span>
            <span class="n">lc_gf</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">line_gf</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc_gf</span><span class="p">)</span>
            <span class="c1"># Add a color bar</span>
            <span class="n">cbar_gf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">line_gf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">pad</span><span class="o">=-</span><span class="mf">0.051</span><span class="p">)</span>
            <span class="n">cbar_gf</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$f_</span><span class="si">{ci}</span><span class="s2">$ [Hz]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

            <span class="c1"># --- Add Shock Crossing Line if Provided ---</span>
            <span class="k">if</span> <span class="n">shock_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">shock_time</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:cyan&quot;</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># --- Decorations ---</span>
            <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t [s]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">right</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="c1"># Adjust legends</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;large&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Particle ID: </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outname</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Saved figure to </span><span class="si">{</span><span class="n">outname</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="FLEKSTP.plot_location">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.plot_location">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pData</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the location of particles pData.</span>

<span class="sd">        Examples:</span>
<span class="sd">        &gt;&gt;&gt; ids, pData = tp.read_particles_at_time(3700, doSave=True)</span>
<span class="sd">        &gt;&gt;&gt; f = tp.plot_location(pData)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">px</span> <span class="o">=</span> <span class="n">pData</span><span class="p">[:,</span> <span class="n">Indices</span><span class="o">.</span><span class="n">X</span><span class="p">]</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">pData</span><span class="p">[:,</span> <span class="n">Indices</span><span class="o">.</span><span class="n">Y</span><span class="p">]</span>
        <span class="n">pz</span> <span class="o">=</span> <span class="n">pData</span><span class="p">[:,</span> <span class="n">Indices</span><span class="o">.</span><span class="n">Z</span><span class="p">]</span>

        <span class="c1"># Create subplot mosaic with different keyword arguments</span>
        <span class="n">skeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">]</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span>
            <span class="s2">&quot;AB;CD&quot;</span><span class="p">,</span>
            <span class="n">per_subplot_kw</span><span class="o">=</span><span class="p">{(</span><span class="s2">&quot;D&quot;</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">}},</span>
            <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create 2D scatter plots</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">([</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">],</span> <span class="p">[</span><span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">pz</span><span class="p">],</span> <span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)])</span>
        <span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Create 3D scatter plot</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">skeys</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="FLEKSTP._calculate_true_gc_trajectory">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._calculate_true_gc_trajectory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_true_gc_trajectory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">smoothing_gyro_periods</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the &#39;true&#39; guiding center trajectory by smoothing.&quot;&quot;&quot;</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
            <span class="n">b_mag_si</span> <span class="o">=</span> <span class="n">b_mag</span> <span class="o">*</span> <span class="mf">1e-9</span>  <span class="c1"># convert nT to T</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># SI</span>
            <span class="n">b_mag_si</span> <span class="o">=</span> <span class="n">b_mag</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-20</span>
        <span class="n">omega_c</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_mag_si</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="n">gyro_period</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">omega_c</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="n">time_steps</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">time_steps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">time_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Could not determine a valid time step. Cannot apply smoothing.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x_true&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y_true&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z_true&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">avg_gyro_period</span> <span class="o">=</span> <span class="n">gyro_period</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">avg_gyro_period</span> <span class="o">*</span> <span class="n">smoothing_gyro_periods</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_steps</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_size</span> <span class="k">if</span> <span class="n">window_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average gyro-period: </span><span class="si">{</span><span class="n">avg_gyro_period</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time step: </span><span class="si">{</span><span class="n">time_steps</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using moving average window size: </span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x_true&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y_true&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z_true&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP._integrate_velocity">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._integrate_velocity">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_integrate_velocity</span><span class="p">(</span>
        <span class="n">v_series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">initial_pos_series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">dt_series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Integrates a velocity series using the trapezoidal rule.&quot;&quot;&quot;</span>
        <span class="n">initial_pos</span> <span class="o">=</span> <span class="n">initial_pos_series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">integrated_pos</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">initial_pos</span> <span class="o">+</span> <span class="p">(((</span><span class="n">v_series</span> <span class="o">+</span> <span class="n">v_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt_series</span><span class="p">)</span><span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">integrated_pos</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">initial_pos</span><span class="p">)</span></div>


<div class="viewcode-block" id="FLEKSTP._calculate_predicted_gc_trajectory">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._calculate_predicted_gc_trajectory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_predicted_gc_trajectory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the predicted guiding center trajectory from theory.&quot;&quot;&quot;</span>
        <span class="n">pt_lazy</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="n">ve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ExB_drift</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>
        <span class="n">vg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gradient_drift</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_curvature_drift</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polarization_drift</span><span class="p">(</span><span class="n">pt_lazy</span><span class="p">)</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-20</span>
        <span class="n">b_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">b_mag_with_fallback</span> <span class="o">=</span> <span class="n">b_mag</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower_bound</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="n">b_unit_x</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag_with_fallback</span>
        <span class="n">b_unit_y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag_with_fallback</span>
        <span class="n">b_unit_z</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_mag_with_fallback</span>

        <span class="n">v_dot_b</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">b_unit_x</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">b_unit_y</span> <span class="o">+</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">b_unit_z</span>

        <span class="n">v_parallel_x</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">*</span> <span class="n">b_unit_x</span>
        <span class="n">v_parallel_y</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">*</span> <span class="n">b_unit_y</span>
        <span class="n">v_parallel_z</span> <span class="o">=</span> <span class="n">v_dot_b</span> <span class="o">*</span> <span class="n">b_unit_z</span>

        <span class="n">v_gc_x</span> <span class="o">=</span> <span class="n">v_parallel_x</span> <span class="o">+</span> <span class="n">ve</span><span class="p">[</span><span class="s2">&quot;vex&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpx&quot;</span><span class="p">]</span>
        <span class="n">v_gc_y</span> <span class="o">=</span> <span class="n">v_parallel_y</span> <span class="o">+</span> <span class="n">ve</span><span class="p">[</span><span class="s2">&quot;vey&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpy&quot;</span><span class="p">]</span>
        <span class="n">v_gc_z</span> <span class="o">=</span> <span class="n">v_parallel_z</span> <span class="o">+</span> <span class="n">ve</span><span class="p">[</span><span class="s2">&quot;vez&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vg</span><span class="p">[</span><span class="s2">&quot;vgz&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;vcz&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vp</span><span class="p">[</span><span class="s2">&quot;vpz&quot;</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">pos_gc_pred_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrate_velocity</span><span class="p">(</span><span class="n">v_gc_x</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">pos_gc_pred_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrate_velocity</span><span class="p">(</span><span class="n">v_gc_y</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">pos_gc_pred_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrate_velocity</span><span class="p">(</span><span class="n">v_gc_z</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pos_gc_pred_x</span><span class="p">,</span> <span class="n">pos_gc_pred_y</span><span class="p">,</span> <span class="n">pos_gc_pred_z</span></div>


<div class="viewcode-block" id="FLEKSTP._plot_gc_verification">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP._plot_gc_verification">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_gc_verification</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pt</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">pos_gc_true</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">pos_gc_pred</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the verification results.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Guiding Center Model Verification for Particle ID: </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span>
        <span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="n">coord_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">coord</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">coord_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">coord</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Full Trajectory (</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">pos_gc_true</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s2">_true&quot;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&#39;True&#39; GC (Smoothed)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">pos_gc_pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted GC (Integrated)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;planetary&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position [$R_E$]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position [m]&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">-Component&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [s]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="FLEKSTP.verify_guiding_center_model">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.FLEKSTP.verify_guiding_center_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_guiding_center_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pID</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">smoothing_gyro_periods</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the guiding center model by comparing it against the full</span>
<span class="sd">        particle trajectory.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Calculates a &quot;true&quot; guiding center trajectory by applying a low-pass</span>
<span class="sd">           filter (moving average) to the full particle trajectory, smoothing</span>
<span class="sd">           out the gyromotion.</span>
<span class="sd">        2. Calculates a &quot;predicted&quot; guiding center trajectory by numerically</span>
<span class="sd">           integrating the guiding center velocity, which is the sum of the</span>
<span class="sd">           parallel velocity and all perpendicular drift velocities (E x B,</span>
<span class="sd">           gradient, curvature, and polarization).</span>
<span class="sd">        3. Generates a plot comparing the full trajectory, the &quot;true&quot; GC</span>
<span class="sd">           trajectory, and the &quot;predicted&quot; GC trajectory for each coordinate (X, Y, Z).</span>

<span class="sd">        A close overlap between the &quot;true&quot; and &quot;predicted&quot; trajectories</span>
<span class="sd">        validates the guiding center approximation and the drift calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            pID (Tuple[int, int]): The ID of the particle to analyze.</span>
<span class="sd">            smoothing_gyro_periods (float): The size of the moving average window</span>
<span class="sd">                                            in units of gyro-periods. Defaults to 1.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pID</span><span class="p">]</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting trajectory for </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verifying guiding center model for particle ID: </span><span class="si">{</span><span class="n">pID</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Calculate &quot;true&quot; guiding center trajectory</span>
        <span class="n">pos_gc_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_true_gc_trajectory</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">smoothing_gyro_periods</span><span class="p">)</span>

        <span class="c1"># 2. Calculate predicted guiding center trajectory</span>
        <span class="n">pos_gc_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_predicted_gc_trajectory</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">pID</span><span class="p">)</span>

        <span class="c1"># 3. Plot the comparison</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_gc_verification</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">pos_gc_true</span><span class="p">,</span> <span class="n">pos_gc_pred</span><span class="p">,</span> <span class="n">pID</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="interpolate_at_times">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.interpolate_at_times">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interpolate_at_times</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">],</span> <span class="n">times_to_interpolate</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates multiple numeric columns of a DataFrame at specified time points.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The input Polars DataFrame or LazyFrame.</span>
<span class="sd">        times_to_interpolate: A list of time points (floats or ints) at which to interpolate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame containing the interpolated rows for each specified time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Identify all numeric columns to be interpolated</span>
    <span class="n">cols_to_interpolate</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">NUMERIC_DTYPES</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">time_col_dtype</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>

    <span class="n">null_rows_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times_to_interpolate</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">times_to_interpolate</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_interpolate</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">time_col_dtype</span><span class="p">))</span>

    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">null_rows_df</span><span class="p">])</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1"># Create a Datetime Series to use for interpolation.</span>
    <span class="n">time_dt_series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span>
        <span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;us&quot;</span>
    <span class="p">)</span>

    <span class="n">interpolated_df</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">cols_to_interpolate</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate_by</span><span class="p">(</span><span class="n">time_dt_series</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">times_to_interpolate</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">interpolated_df</span></div>



<div class="viewcode-block" id="plot_integrated_energy">
<a class="viewcode-back" href="../../../autoapi/flekspy/tp/test_particles/index.html#flekspy.plot_integrated_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_integrated_energy</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots integrated energy quantities as a function of time.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pl.DataFrame): A Polars DataFrame containing a time column and</span>
<span class="sd">                           one or more integrated energy columns.</span>
<span class="sd">        outname (str): If not None, save the plot to file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">time_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">energy_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">energy_columns</span><span class="p">:</span>
        <span class="n">energy_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">column_name</span> <span class="o">==</span> <span class="s2">&quot;W_parallel_integrated&quot;</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\text</span><span class="si">{W}</span><span class="s2">_\parallel$&quot;</span>
        <span class="k">elif</span> <span class="n">column_name</span> <span class="o">==</span> <span class="s2">&quot;W_betatron_integrated&quot;</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\text</span><span class="si">{W}</span><span class="s2">_\text</span><span class="si">{betatron}</span><span class="s2">$&quot;</span>
        <span class="k">elif</span> <span class="n">column_name</span> <span class="o">==</span> <span class="s2">&quot;Wp_integrated&quot;</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\text</span><span class="si">{W}</span><span class="s2">_p$&quot;</span>
        <span class="k">elif</span> <span class="n">column_name</span> <span class="o">==</span> <span class="s2">&quot;ke&quot;</span><span class="p">:</span>
            <span class="n">energy_data</span> <span class="o">=</span> <span class="n">energy_data</span> <span class="o">-</span> <span class="n">energy_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\Delta$KE&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">column_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_integrated&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_data</span><span class="p">,</span> <span class="n">energy_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

    <span class="c1"># Check if all required columns for the sum are present</span>
    <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Wg_integrated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Wc_integrated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Wp_integrated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;W_parallel_integrated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;W_betatron_integrated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ke&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">):</span>
        <span class="n">w_sum</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Wg_integrated&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Wc_integrated&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Wp_integrated&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;W_parallel_integrated&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;W_betatron_integrated&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time_data</span><span class="p">,</span>
            <span class="n">w_sum</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\text</span><span class="si">{W}</span><span class="s2">_\text</span><span class="si">{sum}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ke_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ke&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">delta_ke</span> <span class="o">=</span> <span class="n">ke_data</span> <span class="o">-</span> <span class="n">ke_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">non_adiabatic_heating</span> <span class="o">=</span> <span class="n">delta_ke</span> <span class="o">-</span> <span class="n">w_sum</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time_data</span><span class="p">,</span>
            <span class="n">non_adiabatic_heating</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-adiabatic&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Customize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Integrated Energy (eV)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cumulative Energy Change Over Time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Energy Source&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Yuxi Chen, Hongyang Zhou.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>